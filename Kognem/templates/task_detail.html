{% extends 'base.html' %}
{% load static %}

{% block body %}
<style>
    /* ‚úíÔ∏è –®—Ä–∏—Ñ—Ç—ã –∏ –û—Å–Ω–æ–≤–∞ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');

    body {
        background-color: #f0f4f8; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π, —Ö–æ–ª–æ–¥–Ω—ã–π —Ñ–æ–Ω */
        font-family: 'Inter', sans-serif;
        color: #1a202c;
    }

    /* üì¶ –ì–ª–∞–≤–Ω—ã–π –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .container {
        max-width: 1000px; /* –ù–µ–º–Ω–æ–≥–æ —à–∏—Ä–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        margin: 50px auto;
        padding: 0 20px;
    }

    /* üñºÔ∏è –°–µ–∫—Ü–∏—è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –ì–ê–†–ê–ù–¢–ò–Ø –ß–ï–¢–ö–û–°–¢–ò –ò –ö–ê–î–†–ò–†–û–í–ê–ù–ò–Ø */
    .image-container {
        position: relative;
        overflow: hidden;
        border-radius: 18px; /* –ë–æ–ª–µ–µ —Å–∏–ª—å–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
        margin-bottom: 30px;
        /* –Ø—Ä–∫–∞—è, –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ–Ω—å –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–ø–∞—Ä–µ–Ω–∏—è" */
        box-shadow: 0 20px 50px rgba(49, 130, 206, 0.25); 
    }

    .post-image {
        width: 100%;
        /* üñºÔ∏è –ö–õ–Æ–ß: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω 16:7 –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
        aspect-ratio: 16 / 7; 
        /* üñºÔ∏è –ö–õ–Æ–ß: object-fit: cover - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –±—É–¥–µ—Ç –∏—Å–∫–∞–∂–µ–Ω–∞, 
           –∞ –∑–∞–ø–æ–ª–Ω–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –æ–±—Ä–µ–∑–∞—è –ª–∏—à–Ω–µ–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—è –ß–ï–¢–ö–û–°–¢–¨. */
        object-fit: cover; 
        display: block;
        transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
    }
    
    .image-container:hover .post-image {
        /* –£—Å–∏–ª–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏–∑–º–∞ */
        transform: scale(1.05); 
    }

    /* üìù –ö–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –ö–∞—Ä—Ç–æ—á–∫–∞: –≠—Ñ—Ñ–µ–∫—Ç "–ü–õ–ê–í–ê–Æ–©–ï–ì–û –ó–ê–ì–û–õ–û–í–ö–ê" */
    .content-card {
        background-color: #ffffff;
        border-radius: 18px;
        padding: 45px;
        margin-top: -120px; /* –°–ò–õ–¨–ù–ï–ï –ø–æ–¥–Ω–∏–º–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
        position: relative;
        z-index: 10;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
    }

    .content-card h1 {
        color: #3182ce; /* –ì–ª—É–±–æ–∫–∏–π —Å–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç */
        font-size: 3.2em; /* –ë–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        font-weight: 900; /* –û—á–µ–Ω—å –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
        margin-top: 0;
        padding-bottom: 15px;
        /* –Ø—Ä–∫–∏–π, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π –ø–æ–¥—á–µ—Ä–∫ */
        border-bottom: 5px solid #f6ad55; 
        display: inline-block;
        line-height: 1.1;
    }

    .description-text {
        font-size: 1.2em;
        line-height: 1.8;
        color: #4a5568;
        margin-top: 30px;
        margin-bottom: 40px;
    }

    /* üè∑Ô∏è –ú–µ—Ç–∞-–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–°–µ—Ç–∫–∞) */
    .meta-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
        padding: 25px 0;
        border-top: 2px dashed #e2e8f0;
        border-bottom: 2px dashed #e2e8f0;
    }

    .meta-item strong {
        display: block;
        font-size: 1em;
        color: #718096;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .meta-item span {
        font-size: 1.6em;
        font-weight: 800;
        color: #2d3748;
    }

    .meta-item .price {
        color: #e53e3e; /* –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è —Ü–µ–Ω—ã */
        font-size: 1.8em;
    }
    
    /* üó∫Ô∏è –°–µ–∫—Ü–∏—è –ö–∞—Ä—Ç—ã */
    .map-section {
        background-color: #ffffff;
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        padding: 35px;
        margin-top: 30px;
    }

    .map-section h3 {
        color: #2d3748;
        font-size: 1.6em;
        margin-top: 0;
        margin-bottom: 25px;
        border-left: 6px solid #3182ce;
        padding-left: 20px;
    }

    #map {
        border-radius: 12px;
        border: 2px solid #e2e8f0;
    }

    #distanceInfo {
        margin-top: 20px;
        font-size: 1.2em;
        color: #38a169;
        padding: 15px;
        background-color: #f0fff4;
        border-radius: 10px;
        border: 1px solid #c6f6d5;
        font-weight: 700;
    }

    /* üîô –ö–Ω–æ–ø–∫–∞ */
    .btn-primary {
        background-color: #3182ce;
        color: white;
        padding: 18px 40px;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.3s ease;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        box-shadow: 0 8px 25px rgba(49, 130, 206, 0.4);
    }

    .btn-primary:hover {
        background-color: #2c5282;
        box-shadow: 0 10px 30px rgba(49, 130, 206, 0.6);
        transform: translateY(-2px);
    }
</style>

<main class="container">
    {% if post.image %}
        <div class="image-container">
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="post-image">
        </div>
    {% endif %}

    <div class="content-card">
        <h1>{{ post.title }}</h1>
        
        <p class="description-text">{{ post.description }}</p>

        <div class="meta-grid">
            <div class="meta-item">
                <strong>Task Price</strong>
                <span class="price">${{ post.price }}</span>
            </div>
            <div class="meta-item">
                <strong>Posted by</strong>
                <span>{{ post.user.username }}</span>
            </div>
            <div class="meta-item">
                <strong>Location</strong>
                <span>{{ post.location }}</span>
            </div>
            </div>
    </div>
    
    <div class="map-section">
        <h3>üìç Route from your location to this task</h3>
        <div id="map" style="width: 100%; height: 400px;"></div>
        <div id="distanceInfo"></div>
    </div>

    <a href="{% url 'home' %}" class="btn-primary" style="display:inline-block; margin-top:30px; margin-bottom: 50px;">
        ‚Üê BACK TO ALL TASKS
    </a>
</main>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9KO1U7_6JxlBuCpiLju_K0tXwBM4ISWE=&libraries=places"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const taskLat = parseFloat('{{ post.latitude|default:"40.1792" }}');
        const taskLng = parseFloat('{{ post.longitude|default:"44.4991" }}');

        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: taskLat, lng: taskLng },
            zoom: 13,
            disableDefaultUI: true, /* –ë–æ–ª–µ–µ —á–∏—Å—Ç—ã–π –≤–∏–¥ –∫–∞—Ä—Ç—ã */
            zoomControl: true 
        });

        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer({ 
            map: map,
            polylineOptions: {
                strokeColor: '#f6ad55', /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */
                strokeOpacity: 0.9,
                strokeWeight: 7
            },
            suppressMarkers: true 
        });

        const taskMarker = new google.maps.Marker({
            position: { lat: taskLat, lng: taskLng },
            map: map,
            title: '{{ post.title }}',
            icon: {
                // –ö—Ä–∞—Å–∏–≤—ã–π, —á–∏—Å—Ç—ã–π –∑–Ω–∞—á–æ–∫ –∑–∞–¥–∞–Ω–∏—è
                path: google.maps.SymbolPath.FLAG,
                scale: 6,
                fillColor: "#e53e3e", /* –ö—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –∑–∞–¥–∞–Ω–∏—è */
                fillOpacity: 1,
                strokeWeight: 1,
                strokeColor: "#ffffff"
            }
        });

        const distanceInfo = document.getElementById('distanceInfo');
        let userMarker = null;

        function calculateRoute(userPos) {
            directionsService.route({
                origin: userPos,
                destination: { lat: taskLat, lng: taskLng },
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    const leg = result.routes[0].legs[0];
                    distanceInfo.textContent = `üöó Distance: ${leg.distance.text} | ‚è±Ô∏è Duration: ${leg.duration.text}`;

                    if (!userMarker) {
                        userMarker = new google.maps.Marker({
                            position: userPos,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: "#38a169", 
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: "#fff"
                            },
                            title: "Your Location"
                        });
                    } else {
                        userMarker.setPosition(userPos);
                    }

                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(userPos);
                    bounds.extend({ lat: taskLat, lng: taskLng });
                    map.fitBounds(bounds);
                } else {
                    console.error("Directions request failed:", status);
                    distanceInfo.textContent = '‚ùå Could not calculate route from your location.';
                }
            });
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                calculateRoute(userPos);
            }, err => {
                console.error("Geolocation error:", err);
                distanceInfo.textContent = '‚ö†Ô∏è Geolocation denied or unavailable. Showing task location only.';
                map.setCenter({ lat: taskLat, lng: taskLng });
            }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
        } else {
            distanceInfo.textContent = '‚ö†Ô∏è Geolocation not supported by this browser. Showing task location only.';
            map.setCenter({ lat: taskLat, lng: taskLng });
        }
    });
</script>
{% endblock %}