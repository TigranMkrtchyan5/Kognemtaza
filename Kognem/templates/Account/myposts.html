{% extends 'base.html' %}
{% load static %}

{% block title %}Kognem — Իմ Հայտարարությունները{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary: #6C63FF;
        --primary-dark: #5A52D5;
        --primary-light: #8B85FF;
        --secondary: #FF6584;
        --secondary-dark: #E04F6D;
        --secondary-light: #FF8BA0;
        --accent: #36D1DC;
        --light-bg: #FFFFFF;
        --light-secondary: #F8F9FA;
        --light-border: #E9ECEF;
        --text-dark: #2D3748;
        --text-medium: #4A5568;
        --text-light: #718096;
        --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.03);
        --shadow-medium: 0 10px 15px rgba(0, 0, 0, 0.07);
        --shadow-large: 0 20px 25px rgba(0, 0, 0, 0.1);
        
        /* Status Colors */
        --status-active: #10B981;
        --status-pending: #8B5CF6;
        --status-rejected: #EF4444;
        --status-in-progress: #F59E0B;
        --status-completed: #3B82F6;
        --status-cancelled: #EF4444;
        --status-incomplete: #DC2626;
        --status-waiting: #7C3AED;
        --status-disputed: #D97706;
        --status-worker: #059669;
        --status-owner: #7C3AED;
        --status-under-review: #D97706;
        
        /* Chat Colors - UPDATED */
        --chat-user-bg: #DCF8C6; /* Green for current user */
        --chat-user-border: #B9DFA7;
        --chat-user-text: #0A5E2D;
        --chat-admin-bg: #FFE6E6; /* Red for admin */
        --chat-admin-border: #FFB8B8;
        --chat-admin-text: #B91C1C;
        --chat-other-bg: #FFFFFF; /* White for other users */
        --chat-other-border: #E5E5E5;
        --chat-other-text: #374151;
        --chat-admin-badge: #FF9800;
        --chat-timestamp: #9E9E9E;
        --chat-input-bg: #FFFFFF;
    }

    .page-main {
        min-height: 80vh;
        padding: 40px 20px;
        background: var(--light-bg);
    }

    .profile-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .profile-header {
        text-align: center;
        margin-bottom: 50px;
    }

    .profile-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 15px;
        color: var(--primary);
        line-height: 1.2;
    }

    .profile-subtitle {
        font-size: 1.1rem;
        color: var(--text-medium);
        font-weight: 500;
        line-height: 1.6;
    }

    /* View Type Tabs */
    .view-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .view-tab {
        padding: 12px 24px;
        border: 2px solid var(--light-border);
        border-radius: 12px;
        background: white;
        color: var(--text-medium);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .view-tab:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .view-tab.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    /* Combined Statistics */
    .combined-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border: 1px solid var(--light-border);
        border-radius: 16px;
        padding: 25px;
        text-align: center;
        box-shadow: var(--shadow-light);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--primary);
    }

    .stat-card.worker::before {
        background: var(--secondary);
    }

    .stat-card.combined::before {
        background: linear-gradient(90deg, var(--primary) 50%, var(--secondary) 50%);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-medium);
    }

    .stat-number {
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 8px;
        line-height: 1;
        color: var(--primary);
    }

    .stat-card.worker .stat-number {
        color: var(--secondary);
    }

    .stat-card.combined .stat-number {
        color: var(--text-dark);
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-medium);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-subtitle {
        font-size: 0.8rem;
        color: var(--text-light);
        margin-top: 5px;
    }

    /* Filter Tabs */
    .filter-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .filter-tab {
        padding: 12px 24px;
        border: 2px solid var(--light-border);
        border-radius: 12px;
        background: white;
        color: var(--text-medium);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-tab:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .filter-tab.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    /* Posts Grid */
    .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .post-card {
        background: white;
        border: 1px solid var(--light-border);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-light);
        transition: all 0.3s ease;
        position: relative;
    }

    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-medium);
        border-color: var(--primary-light);
    }

    .post-image-container {
        position: relative;
        height: 220px;
        overflow: hidden;
        background: var(--light-secondary);
    }

    .post-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .post-card:hover .post-image {
        transform: scale(1.05);
    }

    /* Role and Status Badges */
    .post-badges {
        position: absolute;
        top: 15px;
        left: 15px;
        right: 15px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 2;
    }

    .role-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .role-badge.owner { background: var(--status-owner); }
    .role-badge.worker { background: var(--status-worker); }

    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .status-pending { background: var(--status-pending); }
    .status-approved { background: var(--status-active); }
    .status-rejected { background: var(--status-rejected); }
    .status-open { background: var(--status-active); }
    .status-in_progress { background: var(--status-in-progress); }
    .status-completed { background: var(--status-completed); }
    .status-cancelled { background: var(--status-cancelled); }
    .status-incomplete { background: var(--status-incomplete); }
    .status-waiting_approval { background: var(--status-waiting); }
    .status-disputed { background: var(--status-disputed); }
    .status-under_review { background: var(--status-under-review); }

    .post-content {
        padding: 25px;
    }

    .post-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .post-description {
        color: var(--text-dark);
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 20px;
        background: var(--light-secondary);
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid var(--primary);
    }

    /* Info Cards */
    .info-card {
        background: var(--light-secondary);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid var(--primary);
        font-size: 0.9rem;
        color: var(--text-dark);
    }

    .info-card.worker {
        border-left-color: var(--secondary);
    }

    .info-card.warning {
        border-left-color: var(--status-incomplete);
        background: rgba(220, 38, 38, 0.05);
    }

    .info-card.success {
        border-left-color: var(--status-active);
        background: rgba(16, 185, 129, 0.05);
    }

    .info-card.info {
        border-left-color: var(--status-waiting);
        background: rgba(124, 58, 237, 0.05);
    }

    .info-card.dispute {
        border-left-color: var(--status-disputed);
        background: rgba(217, 119, 6, 0.05);
    }

    .info-card.pending {
        border-left-color: var(--status-pending);
        background: rgba(139, 92, 246, 0.05);
    }

    .info-card.review {
        border-left-color: var(--status-under-review);
        background: rgba(217, 119, 6, 0.05);
    }

    /* View Count Styles */
    .view-count {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: var(--text-medium);
        font-weight: 600;
        background: rgba(108, 99, 255, 0.1);
        padding: 6px 12px;
        border-radius: 12px;
    }

    .view-count-high {
        background: rgba(16, 185, 129, 0.1);
        color: var(--status-active);
    }

    .view-count-high i {
        color: var(--status-active);
    }

    .post-views-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--light-border);
    }

    .views-section {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .view-stat {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
        color: var(--text-light);
    }

    .view-stat i {
        color: var(--primary);
    }

    .view-stat .count {
        font-weight: 700;
        color: var(--primary);
    }

    /* Button System */
    .button-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .btn {
        padding: 10px 16px;
        border: 2px solid transparent;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-align: center;
        justify-content: center;
        flex: 1;
        min-width: 120px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .btn-primary { 
        background: var(--primary); 
        color: white; 
        border-color: var(--primary);
    }
    
    .btn-secondary { 
        background: white; 
        color: var(--text-dark); 
        border-color: var(--light-border);
    }
    
    .btn-secondary:hover {
        background: var(--light-secondary);
        border-color: var(--primary);
    }
    
    .btn-success { 
        background: var(--status-active); 
        color: white; 
        border-color: var(--status-active);
    }
    
    .btn-warning { 
        background: var(--status-in-progress); 
        color: white; 
        border-color: var(--status-in-progress);
    }
    
    .btn-danger { 
        background: var(--status-rejected); 
        color: white; 
        border-color: var(--status-rejected);
    }
    
    .btn-info { 
        background: var(--status-waiting); 
        color: white; 
        border-color: var(--status-waiting);
    }
    
    .btn-dispute { 
        background: var(--status-disputed); 
        color: white; 
        border-color: var(--status-disputed);
    }
    
    .btn-gray { 
        background: var(--status-cancelled); 
        color: white; 
        border-color: var(--status-cancelled);
    }

    .btn-full {
        flex: 1;
        min-width: 100%;
    }

    /* Post Meta */
    .post-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--light-border);
    }

    .post-price {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--primary);
    }

    .post-date {
        font-size: 0.85rem;
        color: var(--text-light);
        font-weight: 500;
    }

    /* Applications Count */
    .applications-count {
        background: var(--primary-light);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 8px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 40px;
        background: white;
        border: 1px solid var(--light-border);
        border-radius: 20px;
        box-shadow: var(--shadow-light);
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--text-light);
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 15px;
    }

    .empty-description {
        color: var(--text-medium);
        margin-bottom: 30px;
        line-height: 1.6;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .action-btn-large {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 28px;
        background: var(--primary);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-light);
        border: 2px solid var(--primary);
    }

    .action-btn-large:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-large);
    }

    .action-btn-large.secondary {
        background: var(--secondary);
        border-color: var(--secondary);
    }

    /* Review Popup Styles */
    .review-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .review-popup-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .review-popup {
        background: white;
        border-radius: 20px;
        max-width: 500px;
        width: 100%;
        box-shadow: var(--shadow-large);
        transform: translateY(20px);
        transition: transform 0.3s ease;
        overflow: hidden;
    }

    .review-popup-overlay.active .review-popup {
        transform: translateY(0);
    }

    .review-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        padding: 30px;
        text-align: center;
        color: white;
    }

    .review-header i {
        font-size: 3.5rem;
        margin-bottom: 15px;
        display: block;
    }

    .review-header h3 {
        font-size: 1.6rem;
        font-weight: 700;
        margin: 0 0 10px;
    }

    .review-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1rem;
    }

    .review-content {
        padding: 30px;
    }

    .review-task-info {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--light-border);
    }

    .review-task-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .review-task-user {
        color: var(--text-medium);
        font-size: 1rem;
    }

    .star-rating-review {
        text-align: center;
        margin: 30px 0;
    }

    .star-rating-review .star {
        font-size: 2.8rem;
        color: #E0E0E0;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0 8px;
    }

    .star-rating-review .star:hover {
        transform: scale(1.2);
    }

    .star-rating-review .star.active {
        color: #FFD700;
    }

    .rating-text {
        text-align: center;
        margin-top: 15px;
        font-size: 1.1rem;
        color: var(--text-medium);
        font-weight: 600;
        min-height: 30px;
    }

    .review-comment {
        margin-top: 25px;
    }

    .review-comment label {
        display: block;
        margin-bottom: 12px;
        color: var(--text-dark);
        font-weight: 600;
        font-size: 1rem;
    }

    .review-comment textarea {
        width: 100%;
        padding: 16px;
        border: 2px solid var(--light-border);
        border-radius: 12px;
        resize: vertical;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: var(--light-secondary);
        min-height: 100px;
        font-family: inherit;
    }

    .review-comment textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
    }

    .quick-comments {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
    }

    .quick-comment-btn {
        padding: 10px 15px;
        border: 1px solid var(--light-border);
        border-radius: 8px;
        background: white;
        color: var(--text-medium);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .quick-comment-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(108, 99, 255, 0.05);
    }

    .review-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .review-actions .btn {
        flex: 1;
        padding: 14px;
        font-size: 1rem;
        font-weight: 600;
    }

    .review-success {
        text-align: center;
        padding: 40px 30px;
    }

    .review-success i {
        font-size: 4rem;
        color: var(--status-active);
        margin-bottom: 20px;
        display: block;
    }

    .review-success h4 {
        color: var(--text-dark);
        margin-bottom: 15px;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .review-success p {
        color: var(--text-medium);
        line-height: 1.6;
        margin-bottom: 25px;
    }

    /* Enhanced Dispute Chat Modal Styles - UPDATED */
    .dispute-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .dispute-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .dispute-modal {
        background: white;
        border-radius: 20px;
        max-width: 800px;
        width: 100%;
        box-shadow: var(--shadow-large);
        transform: translateY(20px);
        transition: transform 0.3s ease;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .dispute-modal-overlay.active .dispute-modal {
        transform: translateY(0);
    }

    .dispute-header {
        background: linear-gradient(135deg, var(--status-disputed) 0%, #E67E22 100%);
        padding: 25px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dispute-header-content {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .dispute-header i {
        font-size: 2.5rem;
    }

    .dispute-header h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .dispute-header p {
        margin: 5px 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }

    .dispute-status {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .dispute-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .dispute-chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .dispute-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: 400px;
    }

    /* UPDATED MESSAGE STYLES */
    .dispute-message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
        border: 2px solid transparent;
    }

    .dispute-message.current-user {
        align-self: flex-end;
        background: var(--chat-user-bg);
        color: var(--chat-user-text);
        border-bottom-right-radius: 4px;
        border-color: var(--chat-user-border);
    }

    .dispute-message.admin {
        align-self: flex-start;
        background: var(--chat-admin-bg);
        color: var(--chat-admin-text);
        border-bottom-left-radius: 4px;
        border-color: var(--chat-admin-border);
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
    }

    .dispute-message.other-user {
        align-self: flex-start;
        background: var(--chat-other-bg);
        color: var(--chat-other-text);
        border-bottom-left-radius: 4px;
        border-color: var(--chat-other-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
    }

    .message-sender {
        font-weight: 600;
        font-size: 0.85rem;
    }

    .admin-badge {
        background: var(--chat-admin-badge);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .message-content {
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .message-timestamp {
        font-size: 0.75rem;
        color: var(--chat-timestamp);
        text-align: right;
    }

    .dispute-message.admin .message-timestamp,
    .dispute-message.other-user .message-timestamp {
        text-align: left;
    }

    .message-images {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .message-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 1px solid var(--light-border);
        transition: transform 0.2s ease;
    }

    .message-image:hover {
        transform: scale(1.05);
    }

    .message-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .dispute-input-area {
        padding: 20px;
        border-top: 1px solid var(--light-border);
        background: var(--chat-input-bg);
    }

    .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .dispute-form-group {
        flex: 1;
        margin-bottom: 15px;
    }

    .dispute-form-group textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid var(--light-border);
        border-radius: 12px;
        resize: vertical;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: var(--light-secondary);
        min-height: 80px;
        font-family: inherit;
    }

    .dispute-form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
    }

    /* Modern File Upload Button */
    .file-upload-btn {
        width: 50px;
        height: 50px;
        border: 2px dashed var(--primary);
        border-radius: 12px;
        background: rgba(108, 99, 255, 0.05);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
        margin-bottom: 15px;
    }

    .file-upload-btn:hover {
        background: var(--primary);
        color: white;
        transform: scale(1.05);
    }

    .file-upload-btn i {
        font-size: 1.2rem;
    }

    #disputeFileInput {
        display: none;
    }

    .file-preview-container {
        margin-top: 15px;
    }

    .file-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .file-preview {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        height: 100px;
        background: var(--light-secondary);
        box-shadow: var(--shadow-light);
        transition: transform 0.2s ease;
    }

    .file-preview:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .file-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .file-preview .remove-file {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .file-preview .remove-file:hover {
        background: rgba(239, 68, 68, 1);
        transform: scale(1.1);
    }

    .dispute-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .dispute-actions .btn {
        flex: 1;
        padding: 12px;
        font-size: 1rem;
        font-weight: 600;
    }

    /* Resolution card styles */
    .resolution-card {
        margin-top: 1rem;
        border: 1px solid var(--light-border);
        border-radius: 12px;
        overflow: hidden;
    }

    .resolution-card .card-header {
        background: var(--status-active);
        color: white;
        padding: 15px 20px;
        font-weight: 600;
    }

    .resolution-card .card-body {
        padding: 20px;
        background: var(--light-secondary);
    }

    /* ENHANCED Image Modal Styles - FIXED */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.3s ease;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .image-modal.active {
        display: flex;
    }

    .image-modal-content {
        max-width: 90%;
        max-height: 80%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        animation: zoomIn 0.3s ease;
        /* FIXED: Ensure consistent sizing */
        width: auto;
        height: auto;
        min-width: 300px;
        min-height: 300px;
    }

    .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
        z-index: 10002;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-modal-close:hover {
        color: #ccc;
        background: rgba(0, 0, 0, 0.7);
    }

    /* Image Navigation */
    .image-modal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        font-size: 24px;
        padding: 15px 20px;
        cursor: pointer;
        transition: background 0.3s ease;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-modal-nav:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .image-modal-prev {
        left: 30px;
    }

    .image-modal-next {
        right: 30px;
    }

    .image-modal-counter {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 1.1rem;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .posts-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .profile-title {
            font-size: 2rem;
        }

        .combined-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .view-tabs, .filter-tabs {
            flex-direction: column;
        }

        .button-group {
            flex-direction: column;
        }

        .btn {
            min-width: 100%;
        }

        .post-content {
            padding: 20px;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .action-btn-large {
            width: 100%;
            justify-content: center;
        }

        .post-badges {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }

        .status-badge {
            align-self: flex-end;
        }

        .post-views-stats {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }

        .views-section {
            width: 100%;
            justify-content: space-between;
        }

        .review-popup {
            margin: 20px;
        }

        .review-header {
            padding: 25px 20px;
        }

        .review-content {
            padding: 25px 20px;
        }

        .star-rating-review .star {
            font-size: 2.2rem;
            margin: 0 5px;
        }

        .review-actions {
            flex-direction: column;
        }

        .dispute-modal {
            margin: 20px;
            max-height: 95vh;
        }

        .dispute-header {
            padding: 20px;
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .dispute-message {
            max-width: 90%;
        }

        .dispute-input-area {
            padding: 15px;
        }

        .input-row {
            flex-direction: column;
            align-items: stretch;
        }

        .file-upload-btn {
            align-self: flex-start;
            margin-bottom: 10px;
        }

        .image-modal-content {
            max-width: 95%;
            max-height: 70%;
        }

        .image-modal-close {
            top: 10px;
            right: 15px;
            font-size: 30px;
            width: 40px;
            height: 40px;
        }

        .image-modal-nav {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .image-modal-prev {
            left: 15px;
        }

        .image-modal-next {
            right: 15px;
        }
    }

    @media (max-width: 480px) {
        .combined-stats {
            grid-template-columns: 1fr;
        }

        .profile-title {
            font-size: 1.8rem;
        }

        .empty-state {
            padding: 40px 20px;
        }

        .empty-icon {
            font-size: 3rem;
        }

        .post-meta {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }

        .views-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .quick-comments {
            grid-template-columns: 1fr;
        }

        .review-header {
            padding: 20px 15px;
        }

        .review-content {
            padding: 20px 15px;
        }

        .star-rating-review .star {
            font-size: 1.8rem;
            margin: 0 3px;
        }

        .dispute-modal {
            margin: 10px;
        }

        .dispute-header {
            padding: 15px;
        }

        .dispute-messages {
            padding: 15px;
        }

        .dispute-input-area {
            padding: 10px;
        }

        .file-upload-btn {
            width: 45px;
            height: 45px;
        }

        .image-modal-content {
            max-width: 98%;
            max-height: 60%;
        }

        .image-modal-nav {
            width: 40px;
            height: 40px;
            font-size: 18px;
            padding: 10px 15px;
        }
    }
</style>
{% endblock %}

{% block body %}
<main class="page-main">
    <section class="profile-container">
        <!-- Header -->
        <div class="profile-header">
            <h1 class="profile-title">Իմ Հայտարարությունները</h1>
            <p class="profile-subtitle">Կառավարեք և հետևեք Ձեր բոլոր հայտարարություններին և առաջադրանքներին</p>
        </div>

        <!-- View Type Tabs -->
        <div class="view-tabs">
            <a href="?view=all&filter={{ current_filter }}" class="view-tab {% if view_type == 'all' %}active{% endif %}">
                <i class="fas fa-layer-group"></i> Բոլորը
            </a>
            <a href="?view=owner&filter={{ current_filter }}" class="view-tab {% if view_type == 'owner' %}active{% endif %}">
                <i class="fas fa-user-tie"></i> Իմ Հայտարարությունները
            </a>
            <a href="?view=worker&filter={{ current_filter }}" class="view-tab {% if view_type == 'worker' %}active{% endif %}">
                <i class="fas fa-tasks"></i> Իմ Առաջադրանքները
            </a>
        </div>

        <!-- Combined Statistics -->
        <div class="combined-stats">
            <div class="stat-card combined">
                <div class="stat-number">{{ total_combined }}</div>
                <div class="stat-label">Ընդհանուր</div>
                <div class="stat-subtitle">Բոլոր հայտարարություններ և առաջադրանքներ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_posts }}</div>
                <div class="stat-label">Իմ Հայտարարությունները</div>
                <div class="stat-subtitle">Ակտիվ: {{ active_posts }} | Ընթացիկ: {{ in_progress_tasks }}</div>
            </div>
            <div class="stat-card worker">
                <div class="stat-number">{{ total_worker }}</div>
                <div class="stat-label">Իմ Առաջադրանքները</div>
                <div class="stat-subtitle">Ընթացիկ: {{ in_progress_worker }} | Սպասում: {{ waiting_approval_worker }}</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <a href="?view={{ view_type }}&filter=all" class="filter-tab {% if current_filter == 'all' %}active{% endif %}">
                <i class="fas fa-layer-group"></i> Բոլորը
            </a>
            <a href="?view={{ view_type }}&filter=active" class="filter-tab {% if current_filter == 'active' %}active{% endif %}">
                <i class="fas fa-play-circle"></i> Ակտիվ
            </a>
            <a href="?view={{ view_type }}&filter=in_progress" class="filter-tab {% if current_filter == 'in_progress' %}active{% endif %}">
                <i class="fas fa-tasks"></i> Ընթացիկ
            </a>
            <a href="?view={{ view_type }}&filter=waiting_approval" class="filter-tab {% if current_filter == 'waiting_approval' %}active{% endif %}">
                <i class="fas fa-clock"></i> Սպասում
            </a>
            <a href="?view={{ view_type }}&filter=completed" class="filter-tab {% if current_filter == 'completed' %}active{% endif %}">
                <i class="fas fa-check-circle"></i> Ավարտված
            </a>
            <a href="?view={{ view_type }}&filter=incomplete" class="filter-tab {% if current_filter == 'incomplete' %}active{% endif %}">
                <i class="fas fa-times-circle"></i> Անավարտ
            </a>
            <a href="?view={{ view_type }}&filter=cancelled" class="filter-tab {% if current_filter == 'cancelled' %}active{% endif %}">
                <i class="fas fa-ban"></i> Չեղարկված
            </a>
            <a href="?view={{ view_type }}&filter=rejected" class="filter-tab {% if current_filter == 'rejected' %}active{% endif %}">
                <i class="fas fa-times"></i> Մերժված
            </a>
            <!-- Add Under Review Filter -->
            <a href="?view={{ view_type }}&filter=under_review" class="filter-tab {% if current_filter == 'under_review' %}active{% endif %}">
                <i class="fas fa-gavel"></i> Վերանայման տակ
            </a>
        </div>

        {% if posts %}
            <!-- Posts Grid -->
            <div class="posts-grid">
                {% for post in posts %}
                <div class="post-card">
                    <!-- Image -->
                    <div class="post-image-container">
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="post-image">
                        {% else %}
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--primary); color: white; font-size: 3rem;">
                                <i class="fas fa-tasks"></i>
                            </div>
                        {% endif %}
                        
                        <!-- Role and Status Badges -->
                        <div class="post-badges">
                            <!-- Left: Role Badge -->
                            {% if post.user == request.user %}
                                <div class="role-badge owner">
                                    <i class="fas fa-user-tie"></i> Սեփականատեր
                                </div>
                            {% elif post.assigned_to == request.user %}
                                <div class="role-badge worker">
                                    <i class="fas fa-tasks"></i> Աշխատող
                                </div>
                            {% else %}
                                <div class="role-badge" style="background: transparent; box-shadow: none; border: none;"></div>
                            {% endif %}
                            
                            <!-- Right: Status Badge -->
                            <div class="status-badge 
                                {% if post.task_status == 'under_review' or post.is_under_review %}status-under_review
                                {% elif post.disputed_by_worker or post.disputed_by_owner %}status-disputed
                                {% elif post.status == 'rejected' %}status-rejected
                                {% elif post.status == 'pending' %}status-pending
                                {% elif post.task_status == 'waiting_approval' %}status-waiting_approval
                                {% elif post.task_status != 'open' %}status-{{ post.task_status }}
                                {% else %}status-{{ post.status }}{% endif %}">
                                
                                {% if post.task_status == 'under_review' or post.is_under_review %}
                                    Վերանայման տակ
                                {% elif post.disputed_by_worker or post.disputed_by_owner %}
                                    Վիճահարույց
                                {% elif post.status == 'rejected' %}
                                    Մերժված
                                {% elif post.status == 'pending' %}
                                    Սպասում
                                {% elif post.task_status == 'in_progress' %}
                                    Ընթացիկ
                                {% elif post.task_status == 'completed' %}
                                    Ավարտված
                                {% elif post.task_status == 'incomplete' %}
                                    Անավարտ
                                {% elif post.task_status == 'cancelled' %}
                                    Չեղարկված
                                {% elif post.task_status == 'waiting_approval' %}
                                    Սպասում
                                {% elif post.status == 'approved' %}
                                    Ակտիվ
                                {% else %}
                                    {{ post.get_status_display }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="post-content">
                        <h3 class="post-title">{{ post.title }}</h3>
                        
                        <!-- Description - Now clearly visible -->
                        <div class="post-description">
                            {{ post.description|default:"Նկարագրություն չկա"|truncatewords:30 }}
                        </div>

                        <!-- Under Review Notice -->
                        {% if post.task_status == 'under_review' or post.is_under_review %}
                        <div class="info-card review">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i class="fas fa-gavel" style="color: var(--status-under-review); font-size: 1.2rem;"></i>
                                <strong style="color: var(--status-under-review); font-size: 1rem;">Վերանայման Տակ</strong>
                            </div>
                            <p style="margin: 0; color: var(--text-dark); line-height: 1.5;">
                                Այս առաջադրանքը ներկայումս վերանայվում է ադմինիստրացիայի կողմից: 
                                Դուք չեք կարող խմբագրել, ջնջել կամ փոփոխել առաջադրանքը մինչև վերանայումն ավարտվի:
                                {% if post.disputes.exists %}
                                <br>Դիսպուտի ID: #{{ post.disputes.first.id }}
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}

                        <!-- Role Information -->
                        {% if post.user == request.user %}
                            <div class="info-card">
                                <i class="fas fa-user-tie"></i>
                                <strong>Դուք եք հայտարարության սեփականատերը</strong>
                                {% if post.assigned_to %}
                                <br>Աշխատող: {{ post.assigned_to.username }}
                                {% endif %}
                            </div>
                        {% elif post.assigned_to == request.user %}
                            <div class="info-card worker">
                                <i class="fas fa-tasks"></i>
                                <strong>Դուք եք այս առաջադրանքի աշխատողը</strong>
                                <br>Հայտարարության սեփականատեր: {{ post.user.username }}
                            </div>
                        {% endif %}

                        <!-- Pending Moderation Notice -->
                        {% if post.status == 'pending' and post.user == request.user %}
                        <div class="info-card pending">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i class="fas fa-shield-alt" style="color: var(--status-pending); font-size: 1.2rem;"></i>
                                <strong style="color: var(--status-pending); font-size: 1rem;">Ադմինիստրացիայի Ստուգում</strong>
                            </div>
                            <p style="margin: 0; color: var(--text-dark); line-height: 1.5;">
                                Ձեր հայտարարությունը ներկայումս ստուգվում է ադմինիստրացիայի կողմից: 
                                Ստուգումը սովորաբար տևում է մինչև 24 ժամ: Ստուգումից հետո հայտարարությունը կհրապարակվի:
                            </p>
                        </div>
                        {% endif %}

                        <!-- Dispute Notice -->
                        {% if post.disputed_by_worker or post.disputed_by_owner %}
                        <div class="info-card dispute">
                            <strong>⚠️ Վիճահարույց առաջադրանք</strong>
                            <br>Այս առաջադրանքը ուղարկվել է աջակցության թիմին վերանայման համար:
                            {% if post.dispute_reason %}
                            <br><em>Պատճառ: {{ post.dispute_reason }}</em>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Rejection Reason -->
                        {% if post.status == 'rejected' and post.rejection_reason %}
                        <div class="info-card warning">
                            <strong>Մերժման պատճառ:</strong>
                            {{ post.rejection_reason }}
                        </div>
                        {% endif %}

                        <!-- Incomplete Notice -->
                        {% if post.task_status == 'incomplete' and not post.disputed_by_worker %}
                        <div class="info-card warning">
                            <strong>Առաջադրանքը նշված է որպես անավարտ</strong>
                            {% if post.user == request.user %}
                                Դուք կարող եք վերահաստատել այս առաջադրանքը նորից հրապարակելու համար:
                            {% elif post.assigned_to == request.user %}
                                Դուք կարող եք վիճարկել այս որոշումը, եթե համարում եք, որ առաջադրանքը ավարտված է:
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Waiting Approval Notice -->
                        {% if post.task_status == 'waiting_approval' %}
                        <div class="info-card info">
                            <strong>⏳ Սպասում է հաստատման</strong>
                            {% if post.assigned_to == request.user %}
                                <br>Դուք նշել եք այս առաջադրանքը որպես ավարտված։ Սպասեք սեփականատիրոջ հաստատմանը։
                            {% elif post.user == request.user %}
                                <br>Աշխատողը նշել է այս առաջադրանքը որպես ավարտված։ Խնդրում ենք ստուգել և հաստատել։
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Meta Information -->
                        <div class="post-meta">
                            <div class="post-price">
                                {% if post.price %}
                                    {{ post.price }} դրամ
                                {% else %}
                                    Գին չկա
                                {% endif %}
                            </div>
                            <div class="post-date">
                                {{ post.created_at|date:"M d, Y" }}
                            </div>
                        </div>

                        <!-- View Count and Applications Stats -->
                        <div class="post-views-stats">
                            <div class="views-section">
                                <div class="view-stat">
                                    <i class="fas fa-eye"></i>
                                    <span class="count">{{ post.views_count|default:"0" }}</span> դիտում
                                </div>
                                {% if post.user == request.user and post.task_status == 'open' and post.status == 'approved' %}
                                <div class="view-stat">
                                    <i class="fas fa-users"></i>
                                    <span class="count">{{ post.applications.count }}</span> դիմում
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- View Count Badge -->
                            <div class="view-count {% if post.views_count > 10 %}view-count-high{% endif %}">
                                <i class="fas fa-eye"></i>
                                {{ post.views_count|default:"0" }} դիտում
                            </div>
                        </div>

                        <!-- Action Buttons - Hide when under review -->
                        {% if not post.is_under_review and post.task_status != 'under_review' %}
                        <div class="button-group">
                            <!-- View Button -->
                            <a href="{% url 'view_post' post.id %}" class="btn btn-primary">
                                <i class="fas fa-eye"></i> Դիտել
                            </a>

                            <!-- Message Button - White but visible -->
                            {% if post.user == request.user and post.assigned_to and post.status == 'approved' %}
                                <a href="{% url 'create_room' post.assigned_to.username %}" class="btn btn-secondary">
                                    <i class="fas fa-comment"></i> Նամակ
                                </a>
                            {% elif post.assigned_to == request.user and post.status == 'approved' %}
                                <a href="{% url 'create_room' post.user.username %}" class="btn btn-secondary">
                                    <i class="fas fa-comment"></i> Նամակ
                                </a>
                            {% endif %}

                            <!-- Applications Button for Open Tasks -->
                            {% if post.task_status == 'open' and post.status == 'approved' and post.user == request.user %}
                                <a href="{% url 'task_applications' post.id %}" class="btn btn-info">
                                    <i class="fas fa-users"></i> Դիմումներ 
                                    <span class="applications-count">{{ post.applications.count }}</span>
                                </a>
                            {% endif %}

                            <!-- Edit Button for Owner -->
                            {% if post.user == request.user %}
                                <a href="{% url 'edit_post' post.id %}" class="btn btn-secondary">
                                    <i class="fas fa-edit"></i> Խմբագրել
                                </a>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="button-group">
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-edit"></i> Խմբագրել (Անհասանելի)
                            </button>
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-trash"></i> Ջնջել (Անհասանելի)
                            </button>
                            {% if post.disputes.exists %}
                            <button onclick="openDetailDispute({{ post.disputes.first.id }})" class="btn btn-info">
                                <i class="fas fa-comments"></i> Դիտել Դիսպուտը
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Վիճարկել Button - Show only when task is assigned and dispute is not resolved -->
                        <!-- NEW: Added check for dispute_resolved field -->
                        {% if post.assigned_to and post.status == 'approved' and not post.is_under_review and post.task_status != 'under_review' %}
                            {% if post.user == request.user or post.assigned_to == request.user %}
                                {% if not post.has_resolved_dispute %}
                                <div class="button-group">
                                    <button onclick="openDisputeModal({{ post.id }})" class="btn btn-warning">
                                        <i class="fas fa-gavel"></i> Վիճարկել
                                    </button>
                                </div>
                                {% else %}
                                <div class="info-card success">
                                    <strong>✅ Դիսպուտը լուծված է</strong>
                                    <br>Այս առաջադրանքի համար դիսպուտն արդեն լուծվել է ադմինիստրացիայի կողմից և նոր դիսպուտ չի կարող ստեղծվել:
                                </div>
                                {% endif %}
                            {% endif %}
                        {% endif %}

                        <!-- Task Management Buttons - ТОЛЬКО ДЛЯ APPROVED ПОСТОВ -->
                        {% if post.status == 'approved' and not post.is_under_review and post.task_status != 'under_review' %}
                            <!-- Task Management Buttons -->
                            {% if post.task_status == 'incomplete' and post.user == request.user and not post.disputed_by_worker %}
                            <div class="button-group">
                                <button onclick="resubmitTask({{ post.id }})" class="btn btn-success btn-full">
                                    <i class="fas fa-redo"></i> Վերահաստատել Առաջադրանքը
                                </button>
                            </div>
                            {% endif %}

                            <!-- Approval Actions for Owner -->
                            {% if post.task_status == 'waiting_approval' and post.user == request.user and not post.disputed_by_owner %}
                            <div class="button-group">
                                <button onclick="approveCompletion({{ post.id }})" class="btn btn-success">
                                    <i class="fas fa-check"></i> Հաստատել
                                </button>
                                <button onclick="rejectCompletion({{ post.id }})" class="btn btn-danger">
                                    <i class="fas fa-times"></i> Մերժել
                                </button>
                            </div>
                            {% endif %}

                            <!-- Task Management for Owner - Cancel is Red -->
                            {% if post.task_status == 'in_progress' and post.user == request.user %}
                            <div class="button-group">
                                <button onclick="completeTask({{ post.id }})" class="btn btn-success">
                                    <i class="fas fa-check"></i> Ավարտել
                                </button>
                                <button onclick="markIncomplete({{ post.id }})" class="btn btn-warning">
                                    <i class="fas fa-times"></i> Անավարտ
                                </button>
                                <button onclick="cancelTask({{ post.id }})" class="btn btn-danger">
                                    <i class="fas fa-ban"></i> Չեղարկել
                                </button>
                            </div>
                            {% endif %}

                            <!-- Worker Actions - Cancel is Red -->
                            {% if post.task_status == 'in_progress' and post.assigned_to == request.user %}
                            <div class="button-group">
                                <button onclick="workerCompleteTask({{ post.id }})" class="btn btn-success">
                                    <i class="fas fa-check"></i> Ավարտել
                                </button>
                                <button onclick="workerMarkIncomplete({{ post.id }})" class="btn btn-warning">
                                    <i class="fas fa-times"></i> Անավարտ
                                </button>
                                <button onclick="workerCancelTask({{ post.id }})" class="btn btn-danger">
                                    <i class="fas fa-ban"></i> Չեղարկել
                                </button>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <h3 class="empty-title">
                    {% if view_type == 'owner' and current_filter == 'all' %}Դեռևս Հայտարարություններ Չկան
                    {% elif view_type == 'worker' and current_filter == 'all' %}Վերագրված Առաջադրանքներ Չկան
                    {% elif view_type == 'all' and current_filter == 'all' %}Հայտարարություններ և Առաջադրանքներ Չկան
                    {% elif current_filter == 'active' %}Ակտիվ Հայտարարություններ Չկան
                    {% elif current_filter == 'in_progress' %}Ընթացիկ Առաջադրանքներ Չկան
                    {% elif current_filter == 'waiting_approval' %}Հաստատման Սպասող Առաջադրանքներ Չկան
                    {% elif current_filter == 'completed' %}Ավարտված Առաջադրանքներ Չկան
                    {% elif current_filter == 'incomplete' %}Անավարտ Առաջադրանքներ Չկան
                    {% elif current_filter == 'cancelled' %}Չեղարկված Առաջադրանքներ Չկան
                    {% elif current_filter == 'rejected' %}Մերժված Հայտարարություններ Չկան
                    {% elif current_filter == 'under_review' %}Վերանայման Տակ Գտնվող Առաջադրանքներ Չկան
                    {% else %}Հայտարարություններ Չկան{% endif %}
                </h3>
                <p class="empty-description">
                    {% if view_type == 'owner' and current_filter == 'all' %}
                    Դուք դեռ չունեք հայտարարություններ։ Ստեղծեք Ձեր առաջին հայտարարությունը հենց հիմա։
                    {% elif view_type == 'worker' and current_filter == 'all' %}
                    Դուք դեռ չունեք վերագրված առաջադրանքներ։ Դիմեք առաջադրանքների և սպասեք, որ Ձեզ վերագրեն։
                    {% elif view_type == 'all' and current_filter == 'all' %}
                    Դուք դեռ չունեք ոչ հայտություններ, ոչ վերագրված առաջադրանքներ։
                    {% else %}
                    Այս կատեգորիայում հայտարարություններ չկան։
                    {% endif %}
                </p>
                <div class="action-buttons">
                    {% if view_type != 'worker' %}
                    <a href="{% url 'create_post' %}" class="action-btn-large">
                        <i class="fas fa-plus-circle"></i>
                        Ստեղծել Նոր Հայտարարություն
                    </a>
                    {% endif %}
                    {% if view_type != 'owner' %}
                    <a href="{% url 'ashxatanq' %}" class="action-btn-large secondary">
                        <i class="fas fa-search"></i>
                        Փնտրել Առաջադրանքներ
                    </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </section>
</main>

<!-- Review Popup -->
<div class="review-popup-overlay" id="reviewPopup">
    <div class="review-popup">
        <div class="review-header">
            <i class="fas fa-star"></i>
            <h3>Գնահատեք աշխատանքը</h3>
            <p>Կիսվեք ձեր տպավորություններով</p>
        </div>
        
        <div class="review-content">
            <div id="reviewPopupContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Dispute Chat Modal -->
<div class="dispute-modal-overlay" id="disputeModal">
    <div class="dispute-modal">
        <div class="dispute-header">
            <div class="dispute-header-content">
                <i class="fas fa-gavel"></i>
                <div>
                    <h3>Դիսպուտի Հաղորդակցություն</h3>
                    <p>Հաղորդակցվեք ադմինիստրատորների հետ այս դիսպուտի վերաբերյալ</p>
                </div>
            </div>
            <div class="dispute-status" id="disputeStatus">Ակտիվ</div>
        </div>
        
        <div class="dispute-body">
            <div class="dispute-chat-container">
                <div class="dispute-messages" id="disputeMessages">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div class="dispute-input-area">
                    <div class="input-row">
                        <div class="dispute-form-group">
                            <textarea id="disputeMessage" rows="3" placeholder="Մուտքագրեք ձեր հաղորդագրությունը (ըստ ցանկության)..." style="width: 100%;"></textarea>
                        </div>
                        <div class="file-upload-btn" onclick="document.getElementById('disputeFileInput').click()" title="Վերբեռնել նկարներ">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <input type="file" id="disputeFileInput" accept="image/*" multiple style="display: none;">
                    
                    <div class="file-preview-container" id="filePreviewContainer">
                        <div class="file-preview-grid" id="filePreviewGrid">
                            <!-- File previews will be added here -->
                        </div>
                    </div>
                    
                    <div class="dispute-actions">
                        <button onclick="closeDisputeModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Փակել
                        </button>
                        <button onclick="sendDisputeMessage()" class="btn btn-primary" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i> Ուղարկել Հաղորդագրություն
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ENHANCED Image Modal with Navigation -->
<div id="imageModal" class="image-modal">
    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
    <button class="image-modal-nav image-modal-prev" onclick="navigateImage(-1)">❮</button>
    <img class="image-modal-content" id="imageModalImage">
    <button class="image-modal-nav image-modal-next" onclick="navigateImage(1)">❯</button>
    <div class="image-modal-counter" id="imageCounter"></div>
</div>

<!-- Debug Panel -->
<div style="position: fixed; bottom: 10px; right: 10px; z-index: 10000; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #ddd; display: none;" id="debugPanel">
    <button onclick="testImageFunctionality()" style="background: #6C63FF; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-bottom: 5px; width: 100%;">
        Test Images
    </button>
    <button onclick="debugDisputeState()" style="background: #FF6584; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; width: 100%;">
        Debug State
    </button>
</div>

<script>
    // Global variables
    let currentContactPostId = null;
    let currentDisputeId = null;
    let currentReviewData = null;
    let selectedRating = 0;
    let uploadedFiles = [];
    
    // Image modal variables
    let currentImageIndex = 0;
    let currentMessageImages = [];

    // ==================== DISPUTE MODAL FUNCTIONS ====================

    function openDisputeModal(postId) {
        currentContactPostId = postId;
        document.getElementById('disputeModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Reset form
        document.getElementById('disputeMessage').value = '';
        document.getElementById('disputeFileInput').value = '';
        uploadedFiles = [];
        updateFilePreviews();
        
        // Load existing dispute if any
        loadExistingDispute(postId);
    }

    function openDetailDispute(disputeId) {
        currentDisputeId = disputeId;
        document.getElementById('disputeModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Reset form
        document.getElementById('disputeMessage').value = '';
        document.getElementById('disputeFileInput').value = '';
        uploadedFiles = [];
        updateFilePreviews();
        
        // Load dispute messages
        loadDisputeMessages(disputeId);
    }

    function closeDisputeModal() {
        document.getElementById('disputeModal').classList.remove('active');
        document.body.style.overflow = 'auto';
        currentContactPostId = null;
        currentDisputeId = null;
    }

    function loadExistingDispute(postId) {
        fetch(`/task/${postId}/check-dispute/`)
            .then(response => response.json())
            .then(data => {
                if (data.exists && data.dispute_id) {
                    currentDisputeId = data.dispute_id;
                    document.getElementById('disputeStatus').textContent = data.resolved ? 'Լուծված' : 'Ակտիվ';
                    loadDisputeMessages(data.dispute_id);
                } else {
                    // No existing dispute, show empty state
                    showEmptyDisputeState();
                }
            })
            .catch(error => {
                console.error('Error checking dispute:', error);
                showEmptyDisputeState();
            });
    }

    function loadDisputeMessages(disputeId) {
        console.log('🔄 Loading messages for dispute:', disputeId);
        
        fetch(`/dispute/${disputeId}/get-messages/`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log('📨 Received messages data:', data);
                
                if (data.success) {
                    displayDisputeMessages(data.messages);
                    updateDisputeStatus(data.resolved);
                } else {
                    console.error('Error loading messages:', data.error);
                    showErrorState('Failed to load messages: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Network error loading messages:', error);
                showErrorState('Network error: ' + error.message);
            });
    }

    function displayDisputeMessages(messages) {
        const container = document.getElementById('disputeMessages');
        container.innerHTML = '';
        
        console.log('🎯 Displaying messages:', messages);

        if (!messages || messages.length === 0) {
            showEmptyDisputeState();
            return;
        }

        const currentUsername = '{{ request.user.username }}';
        
        messages.forEach(msg => {
            const messageElement = createMessageElement(msg, currentUsername);
            container.appendChild(messageElement);
        });
        
        container.scrollTop = container.scrollHeight;
    }

    function createMessageElement(msg, currentUsername) {
        const messageDiv = document.createElement('div');
        const isAdmin = msg.is_admin || isUserAdmin(msg.sender);
        const isCurrentUser = msg.sender === currentUsername;
        
        const messageClass = getMessageClass(isAdmin, isCurrentUser);
        messageDiv.className = `dispute-message ${messageClass}`;
        
        messageDiv.innerHTML = buildMessageHTML(msg, isAdmin);
        
        // Store images for this message for modal navigation
        const images = extractImagesFromMessage(msg);
        if (images.length > 0) {
            messageDiv.dataset.images = JSON.stringify(images);
        }
        
        return messageDiv;
    }

    function isUserAdmin(sender) {
        return sender && (sender.toLowerCase().includes('admin') || sender.toLowerCase().includes('ադմին'));
    }

    function getMessageClass(isAdmin, isCurrentUser) {
        if (isAdmin) return 'admin';
        if (isCurrentUser) return 'current-user';
        return 'other-user';
    }

    function buildMessageHTML(msg, isAdmin) {
        let html = '';

        // Sender header
        if (msg.sender) {
            html += `
                <div class="message-header">
                    <div class="message-sender">${msg.sender}</div>
                    ${isAdmin ? '<div class="admin-badge">Ադմին</div>' : ''}
                </div>
            `;
        }

        // Message content
        if (msg.message && msg.message.trim() !== '') {
            html += `<div class="message-content">${msg.message}</div>`;
        }

        // Images
        const imagesHTML = buildImagesHTML(msg);
        if (imagesHTML) {
            html += imagesHTML;
        }

        // Timestamp
        const timestamp = msg.created_at || msg.formatted_time || 'Հիմա';
        html += `<div class="message-timestamp">${timestamp}</div>`;

        return html;
    }

    function buildImagesHTML(msg) {
        const images = extractImagesFromMessage(msg);
        
        if (images.length === 0) {
            return '';
        }

        console.log('🖼️ Building images HTML for message:', images);

        let imagesHTML = '<div class="message-images">';
        
        images.forEach((imageUrl, index) => {
            const absoluteUrl = makeAbsoluteUrl(imageUrl);
            imagesHTML += `
                <div class="message-image" onclick="openImageModalFromMessage(this, ${index})">
                    <img src="${absoluteUrl}" alt="Ապացույց">
                </div>
            `;
        });
        
        imagesHTML += '</div>';
        return imagesHTML;
    }

    function extractImagesFromMessage(msg) {
        const images = [];

        // Check for images array
        if (msg.images && Array.isArray(msg.images)) {
            msg.images.forEach(img => {
                if (typeof img === 'string') {
                    images.push(img);
                } else if (img.url) {
                    images.push(img.url);
                } else if (img.image_url) {
                    images.push(img.image_url);
                }
            });
        }

        // Check for single image fields
        if (msg.image_url) {
            images.push(msg.image_url);
        }
        if (msg.image) {
            images.push(msg.image);
        }

        console.log('📸 Extracted images:', images);
        return images;
    }

    function makeAbsoluteUrl(url) {
        if (!url) return '';
        
        // If it's already an absolute URL, return as is
        if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('//')) {
            return url;
        }
        
        // If it starts with /, it's already relative to domain
        if (url.startsWith('/')) {
            return window.location.origin + url;
        }
        
        // Otherwise, assume it's relative to current path
        return window.location.origin + '/' + url;
    }

    function updateDisputeStatus(isResolved) {
        const statusElement = document.getElementById('disputeStatus');
        const messageInput = document.getElementById('disputeMessage');
        const fileInput = document.getElementById('disputeFileInput');
        const uploadBtn = document.querySelector('.file-upload-btn');
        const sendBtn = document.querySelector('.dispute-actions .btn-primary');

        if (isResolved) {
            statusElement.textContent = 'Լուծված';
            messageInput.disabled = true;
            fileInput.disabled = true;
            uploadBtn.style.opacity = '0.5';
            uploadBtn.style.cursor = 'not-allowed';
            sendBtn.disabled = true;
            
            // Auto-close modal after 3 seconds if resolved
            setTimeout(() => {
                closeDisputeModal();
                location.reload();
            }, 3000);
        } else {
            statusElement.textContent = 'Ակտիվ';
            messageInput.disabled = false;
            fileInput.disabled = false;
            uploadBtn.style.opacity = '1';
            uploadBtn.style.cursor = 'pointer';
            sendBtn.disabled = false;
        }
    }

    function showEmptyDisputeState() {
        const container = document.getElementById('disputeMessages');
        container.innerHTML = `
            <div class="dispute-message admin">
                <div class="message-header">
                    <div class="message-sender">Ադմինիստրատոր</div>
                    <div class="admin-badge">Ադմին</div>
                </div>
                <div class="message-content">Բարև ձեզ: Խնդրում ենք նկարագրել ձեր խնդիրը և տրամադրել համապատասխան ապացույցներ: Մենք կուսումնասիրենք ձեր դիմումը և կպատասխանենք հնարավորինս շուտ:</div>
                <div class="message-timestamp">Հիմա</div>
            </div>
        `;
    }

    function showErrorState(message) {
        const container = document.getElementById('disputeMessages');
        container.innerHTML = `
            <div class="dispute-message admin">
                <div class="message-header">
                    <div class="message-sender">Սխալ</div>
                    <div class="admin-badge">Սխալ</div>
                </div>
                <div class="message-content">${message}</div>
                <div class="message-timestamp">Հիմա</div>
            </div>
        `;
    }

    // ==================== MESSAGE SENDING ====================

    function sendDisputeMessage() {
        const message = document.getElementById('disputeMessage').value.trim();
        
        console.log('🚀 SEND MESSAGE DEBUG:');
        console.log('Message:', message);
        console.log('Files to send:', uploadedFiles);
        console.log('Files count:', uploadedFiles.length);
        
        // FIXED: Allow sending with only images, only text, or both
        if (!message && uploadedFiles.length === 0) {
            alert('Խնդրում ենք մուտքագրել հաղորդագրություն կամ վերբեռնել նկար');
            return;
        }

        const formData = new FormData();
        
        // Always append message (even if empty)
        formData.append('message', message);
        
        // FIXED: Append ALL files in one request
        uploadedFiles.forEach((file, index) => {
            console.log(`📤 Appending file ${index}:`, file.name, file.type, file.size);
            formData.append('images', file, file.name);
        });

        // Debug FormData contents
        console.log('📦 FormData contents:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}:`, value);
        }

        const url = currentDisputeId 
            ? `/dispute/${currentDisputeId}/send-message/`
            : `/task/${currentContactPostId}/create-dispute/`;
        
        console.log('📡 Sending to:', url);

        const sendBtn = document.getElementById('sendMessageBtn');
        const originalText = sendBtn.innerHTML;
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ուղարկվում է...';

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                // NO Content-Type header - let browser set it automatically
            },
            body: formData
        })
        .then(response => {
            console.log('📨 Response status:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ Server response:', data);
            
            if (data.success) {
                handleSendSuccess(data);
            } else {
                throw new Error(data.error || 'Unknown server error');
            }
        })
        .catch(error => {
            console.error('❌ Send failed:', error);
            handleSendError(error.message);
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalText;
        });
    }

    function handleSendSuccess(data) {
        console.log('🎉 Message sent successfully!', data);
        
        // Clear the form
        document.getElementById('disputeMessage').value = '';
        uploadedFiles = [];
        updateFilePreviews();
        
        // Update dispute ID if this was a new dispute
        if (data.dispute_id) {
            currentDisputeId = data.dispute_id;
            console.log('🆕 New dispute ID:', currentDisputeId);
        }
        
        // Reload messages
        if (currentDisputeId) {
            console.log('🔄 Reloading messages...');
            loadDisputeMessages(currentDisputeId);
        }
        
        // Show success message
        showTempMessage('✅ Հաղորդագրությունը ուղարկված է', 'success');
    }

    function handleSendError(error) {
        console.error('❌ Error sending message:', error);
        showTempMessage(`❌ Սխալ: ${error}`, 'error');
    }

    function showTempMessage(message, type = 'info') {
        const tempMsg = document.createElement('div');
        tempMsg.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${type === 'success' ? '#10B981' : '#EF4444'};
            color: white;
            border-radius: 8px;
            z-index: 10000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        `;
        tempMsg.textContent = message;
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
            if (document.body.contains(tempMsg)) {
                document.body.removeChild(tempMsg);
            }
        }, 3000);
    }

    // ==================== FILE UPLOAD HANDLING ====================

    function initializeFileUpload() {
        const fileInput = document.getElementById('disputeFileInput');
        
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            console.log('📁 Files selected:', files.length);
            files.forEach(file => console.log('File:', file.name, file.type, file.size));
            
            // Check file limit
            if (uploadedFiles.length + files.length > 5) {
                alert('Դուք կարող եք վերբեռնել առավելագույնը 5 նկար');
                return;
            }
            
            // Filter and add image files
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    uploadedFiles.push(file);
                    console.log('✅ Image added:', file.name);
                } else {
                    console.log('❌ Non-image file skipped:', file.name);
                    alert('Խնդրում ենք վերբեռնել միայն նկարներ');
                }
            });
            
            updateFilePreviews();
            
            // Clear the file input to allow uploading same file again
            fileInput.value = '';
        });
    }

    function updateFilePreviews() {
        const container = document.getElementById('filePreviewContainer');
        const grid = document.getElementById('filePreviewGrid');
        
        grid.innerHTML = '';
        
        if (uploadedFiles.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        uploadedFiles.forEach((file, index) => {
            const preview = createFilePreview(file, index);
            grid.appendChild(preview);
        });
    }

    function createFilePreview(file, index) {
        const preview = document.createElement('div');
        preview.className = 'file-preview';
        
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-file';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeFile(index);
        };
        
        preview.appendChild(img);
        preview.appendChild(removeBtn);
        
        return preview;
    }

    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        updateFilePreviews();
    }

    // ==================== ENHANCED IMAGE MODAL ====================

    function openImageModalFromMessage(imageElement, imageIndex) {
        const messageElement = imageElement.closest('.dispute-message');
        const imagesData = messageElement.dataset.images;
        
        if (imagesData) {
            currentMessageImages = JSON.parse(imagesData);
            currentImageIndex = imageIndex;
            openImageModal(currentMessageImages[currentImageIndex]);
        } else {
            // Fallback: open single image
            const imgSrc = imageElement.querySelector('img').src;
            openImageModal(imgSrc);
        }
    }

    function openImageModal(imageUrl) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('imageModalImage');
        const counter = document.getElementById('imageCounter');
        
        modal.classList.add('active');
        modalImg.src = imageUrl;
        document.body.style.overflow = 'hidden';
        
        // Update counter if we have multiple images
        if (currentMessageImages.length > 1) {
            counter.textContent = `${currentImageIndex + 1} / ${currentMessageImages.length}`;
            counter.style.display = 'block';
        } else {
            counter.style.display = 'none';
        }
        
        // Show/hide navigation buttons
        const prevBtn = document.querySelector('.image-modal-prev');
        const nextBtn = document.querySelector('.image-modal-next');
        
        if (currentMessageImages.length > 1) {
            prevBtn.style.display = 'flex';
            nextBtn.style.display = 'flex';
        } else {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        currentMessageImages = [];
        currentImageIndex = 0;
    }

    function navigateImage(direction) {
        if (currentMessageImages.length === 0) return;
        
        currentImageIndex += direction;
        
        // Loop around
        if (currentImageIndex < 0) {
            currentImageIndex = currentMessageImages.length - 1;
        } else if (currentImageIndex >= currentMessageImages.length) {
            currentImageIndex = 0;
        }
        
        const modalImg = document.getElementById('imageModalImage');
        const counter = document.getElementById('imageCounter');
        
        modalImg.src = currentMessageImages[currentImageIndex];
        counter.textContent = `${currentImageIndex + 1} / ${currentMessageImages.length}`;
    }

    // ==================== DEBUG FUNCTIONS ====================

    function testImageFunctionality() {
        console.log('🧪 Testing image functionality...');
        console.log('Current state:', {
            currentDisputeId,
            currentContactPostId,
            uploadedFiles: uploadedFiles.length,
            message: document.getElementById('disputeMessage').value
        });
        
        // Create a test blob to simulate an image
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#6C63FF';
        ctx.fillRect(0, 0, 100, 100);
        ctx.fillStyle = 'white';
        ctx.font = '20px Arial';
        ctx.fillText('Test', 30, 50);
        
        canvas.toBlob(function(blob) {
            const testFile = new File([blob], 'test-image.png', { type: 'image/png' });
            uploadedFiles = [testFile];
            updateFilePreviews();
            
            console.log('✅ Test image created and added to upload queue');
            console.log('Test file:', testFile);
        });
    }

    function debugDisputeState() {
        console.log('🐛 DEBUG DISPUTE STATE:');
        console.log('currentDisputeId:', currentDisputeId);
        console.log('currentContactPostId:', currentContactPostId);
        console.log('uploadedFiles count:', uploadedFiles.length);
        console.log('uploadedFiles:', uploadedFiles);
        
        // Check if modal is open
        const modal = document.getElementById('disputeModal');
        console.log('Modal active:', modal.classList.contains('active'));
        
        // Check file input
        const fileInput = document.getElementById('disputeFileInput');
        console.log('File input files:', fileInput.files);
    }

    // ==================== TASK MANAGEMENT FUNCTIONS ====================

    function completeTask(postId) {
        if (confirm('Հաստատեք, որ առաջադրանքը ավարտված է?')) {
            fetch(`/task/${postId}/complete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReviewPopup({
                        postId: postId,
                        reviewedUserId: data.assigned_to_id,
                        reviewType: 'owner_to_worker',
                        taskTitle: data.task_title,
                        userName: data.worker_username
                    });
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function markIncomplete(postId) {
        if (confirm('Հաստատեք, որ առաջադրանքը անավարտ է?')) {
            fetch(`/task/${postId}/incomplete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function cancelTask(postId) {
        if (confirm('Հաստատեք առաջադրանքի չեղարկումը?')) {
            fetch(`/task/${postId}/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function resubmitTask(postId) {
        if (confirm('Հաստատեք առաջադրանքի վերահաստատումը? Այն կրկին հասանելի կլինի այլ օգտատերերի համար:')) {
            fetch(`/task/${postId}/resubmit/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function approveCompletion(postId) {
        if (confirm('Հաստատեք առաջադրանքի ավարտը?')) {
            fetch(`/task/${postId}/approve-completion/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReviewPopup({
                        postId: postId,
                        reviewedUserId: data.worker_id,
                        reviewType: 'owner_to_worker',
                        taskTitle: data.task_title,
                        userName: data.worker_username
                    });
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function rejectCompletion(postId) {
        if (confirm('Մերժե՞լ ավարտը և նշել որպես անավարտ:')) {
            fetch(`/task/${postId}/reject-completion/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    // Worker Task Management Functions
    function workerCompleteTask(taskId) {
        if (confirm('Հաստատեք, որ առաջադրանքը ավարտված է? Այն կուղարկվի սեփականատիրոջը հաստատման:')) {
            fetch(`/task/${taskId}/worker/complete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReviewPopup({
                        postId: taskId,
                        reviewedUserId: data.owner_id,
                        reviewType: 'worker_to_owner',
                        taskTitle: data.task_title,
                        userName: data.owner_username
                    });
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function workerMarkIncomplete(taskId) {
        if (confirm('Հաստատեք, որ առաջադրանքը անավարտ է?')) {
            fetch(`/task/${taskId}/worker/incomplete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    function workerCancelTask(taskId) {
        if (confirm('Հաստատեք առաջադրանքի չեղարկումը?')) {
            fetch(`/task/${taskId}/worker/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Սխալ: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ցանցի սխալ: ' + error);
            });
        }
    }

    // ==================== REVIEW POPUP FUNCTIONS ====================

    function showReviewPopup(reviewData) {
        currentReviewData = reviewData;
        selectedRating = 0;
        
        const popupContent = document.getElementById('reviewPopupContent');
        const ratingDescriptions = {
            1: "Շատ վատ - Շատ անբավարար աշխատանք",
            2: "Վատ - Կան բազմաթիվ թերություններ",
            3: "Միջին - Բավարար աշխատանք",
            4: "Լավ - Բարձրորակ աշխատանք",
            5: "Գերազանց - Հիանալի աշխատանք"
        };
        
        popupContent.innerHTML = `
            <div class="review-task-info">
                <div class="review-task-title">${reviewData.taskTitle}</div>
                <div class="review-task-user">
                    ${reviewData.reviewType === 'owner_to_worker' ? 'Աշխատող' : 'Հայտարարության սեփականատեր'}: ${reviewData.userName}
                </div>
            </div>
            
            <div class="star-rating-review">
                <span class="star" data-rating="1">★</span>
                <span class="star" data-rating="2">★</span>
                <span class="star" data-rating="3">★</span>
                <span class="star" data-rating="4">★</span>
                <span class="star" data-rating="5">★</span>
                <div class="rating-text" id="ratingText">Ընտրեք գնահատականը</div>
            </div>
            
            <div class="review-comment">
                <label for="reviewComment">Մեկնաբանություն (ըստ ցանկության)</label>
                <textarea id="reviewComment" placeholder="Կիսվեք ձեր տպավորություններով..."></textarea>
                
                <div class="quick-comments">
                    <div class="quick-comment-btn" onclick="setQuickComment('Աշխատանքը կատարվել է ժամանակին')">Աշխատանքը կատարվել է ժամանակին</div>
                    <div class="quick-comment-btn" onclick="setQuickComment('Բարձր որակի աշխատանք')">Բարձր որակի աշխատանք</div>
                    <div class="quick-comment-btn" onclick="setQuickComment('Լավ հաղորդակցություն')">Լավ հաղորդակցություն</div>
                    <div class="quick-comment-btn" onclick="setQuickComment('Խորհուրդ կտայի ուրիշներին')">Խորհուրդ կտայի ուրիշներին</div>
                </div>
            </div>
            
            <div class="review-actions">
                <button onclick="closeReviewPopup()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Փակել
                </button>
                <button onclick="submitReview()" class="btn btn-primary" id="submitReviewBtn" disabled>
                    <i class="fas fa-paper-plane"></i> Ուղարկել գնահատականը
                </button>
            </div>
        `;
        
        // Add event listeners to stars
        const stars = popupContent.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.getAttribute('data-rating'));
                updateStars();
                document.getElementById('ratingText').textContent = ratingDescriptions[selectedRating];
                document.getElementById('submitReviewBtn').disabled = false;
            });
            
            star.addEventListener('mouseover', () => {
                const hoverRating = parseInt(star.getAttribute('data-rating'));
                highlightStars(hoverRating);
            });
        });
        
        // Reset stars when mouse leaves the container
        const starContainer = popupContent.querySelector('.star-rating-review');
        starContainer.addEventListener('mouseleave', updateStars);
        
        // Show popup
        document.getElementById('reviewPopup').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function setQuickComment(comment) {
        document.getElementById('reviewComment').value = comment;
    }

    function highlightStars(rating) {
        const stars = document.querySelectorAll('.star-rating-review .star');
        stars.forEach(star => {
            const starRating = parseInt(star.getAttribute('data-rating'));
            if (starRating <= rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    function updateStars() {
        const stars = document.querySelectorAll('.star-rating-review .star');
        stars.forEach(star => {
            const starRating = parseInt(star.getAttribute('data-rating'));
            if (starRating <= selectedRating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    function closeReviewPopup() {
        document.getElementById('reviewPopup').classList.remove('active');
        document.body.style.overflow = 'auto';
        currentReviewData = null;
        selectedRating = 0;
    }

    function submitReview() {
        if (selectedRating === 0) {
            alert('Խնդրում ենք ընտրել գնահատական');
            return;
        }

        const comment = document.getElementById('reviewComment').value;
        
        fetch('/submit-review/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_id: currentReviewData.postId,
                reviewed_user_id: currentReviewData.reviewedUserId,
                review_type: currentReviewData.reviewType,
                rating: selectedRating,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success state
                const popupContent = document.getElementById('reviewPopupContent');
                popupContent.innerHTML = `
                    <div class="review-success">
                        <i class="fas fa-check-circle"></i>
                        <h4>Շնորհակալություն գնահատականի համար</h4>
                        <p>Ձեր գնահատականը հաջողությամբ ուղարկվել է։ Այն կօգնի այլ օգտատերերին ընտրել հուսալի գործընկերներ։</p>
                        <button onclick="closeReviewPopup()" class="btn btn-primary" style="min-width: 200px;">
                            <i class="fas fa-check"></i> Հասկանալի է
                        </button>
                    </div>
                `;
                
                // Auto close after 3 seconds
                setTimeout(() => {
                    closeReviewPopup();
                    location.reload();
                }, 3000);
            } else {
                alert('Սխալ: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ցանցի սխալ: ' + error);
        });
    }

    // ==================== EVENT LISTENERS ====================

    function initializeEventListeners() {
        // Image modal click outside to close
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Keyboard navigation for image modal
        document.addEventListener('keydown', function(e) {
            const imageModal = document.getElementById('imageModal');
            if (imageModal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeImageModal();
                } else if (e.key === 'ArrowLeft') {
                    navigateImage(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateImage(1);
                }
            }
        });

        // Modal close when clicking outside
        window.onclick = function(event) {
            const reviewPopup = document.getElementById('reviewPopup');
            const disputeModal = document.getElementById('disputeModal');
            
            if (event.target === reviewPopup) {
                closeReviewPopup();
            }
            if (event.target === disputeModal) {
                closeDisputeModal();
            }
        };

        // Initialize file upload
        initializeFileUpload();

        // Show debug panel on Ctrl+Shift+D
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            }
        });
    }

    // ==================== INITIALIZATION ====================

    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        
        // Add scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -30px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationPlayState = 'running';
                }
            });
        }, observerOptions);

        // Observe all animated elements
        document.querySelectorAll('.view-tabs, .combined-stats, .filter-tabs, .posts-grid, .empty-state').forEach(element => {
            element.style.animationPlayState = 'paused';
            observer.observe(element);
        });

        // Add hover effects to post cards
        const postCards = document.querySelectorAll('.post-card');
        postCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        console.log('🚀 Dispute chat system initialized successfully');
        console.log('💡 Press Ctrl+Shift+D to toggle debug panel');
    });

    // ==================== GLOBAL ACCESS ====================

    // Make functions globally available
    window.openDisputeModal = openDisputeModal;
    window.openDetailDispute = openDetailDispute;
    window.closeDisputeModal = closeDisputeModal;
    window.sendDisputeMessage = sendDisputeMessage;
    window.openImageModal = openImageModal;
    window.openImageModalFromMessage = openImageModalFromMessage;
    window.closeImageModal = closeImageModal;
    window.navigateImage = navigateImage;
    window.testImageFunctionality = testImageFunctionality;
    window.debugDisputeState = debugDisputeState;

</script>
{% endblock %}