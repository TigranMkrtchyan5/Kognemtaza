{% extends 'base.html' %}
{% load static %}

{% block title %}Kognem — {{ post.title }}{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary: #6C63FF;
        --primary-dark: #5A52D5;
        --primary-light: #8B85FF;
        --secondary: #FF6584;
        --secondary-dark: #E04F6D;
        --secondary-light: #FF8BA0;
        --accent: #36D1DC;
        --light-bg: #FFFFFF;
        --light-secondary: #F8F9FA;
        --light-border: #E9ECEF;
        --text-dark: #2D3748;
        --text-medium: #4A5568;
        --text-light: #718096;
        --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.03);
        --shadow-medium: 0 10px 15px rgba(0, 0, 0, 0.07);
        --shadow-large: 0 20px 25px rgba(0, 0, 0, 0.1);
    }

    .page-main {
        min-height: 80vh;
        padding: 40px 20px;
        background: var(--light-bg);
        position: relative;
        overflow: hidden;
    }

    .post-detail-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border: 1px solid var(--light-border);
        border-radius: 24px;
        box-shadow: var(--shadow-medium);
        overflow: hidden;
        transform: translateY(30px);
        opacity: 0;
        animation: fadeInUp 1s forwards 0.2s;
    }

    /* Header Section */
    .post-header {
        padding: 40px 40px 30px;
        border-bottom: 1px solid var(--light-border);
        background: var(--light-secondary);
    }

    .post-title {
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 15px;
        color: var(--text-dark);
        line-height: 1.3;
    }

    .post-meta {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .post-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-approved {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-rejected {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-worker {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .status-active {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .post-date {
        color: var(--text-light);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Main Content Layout */
    .post-main-content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 0;
    }

    /* Left Column - Content */
    .post-content-column {
        padding: 40px;
        border-right: 1px solid var(--light-border);
    }

    /* Image Section */
    .post-image-section {
        margin-bottom: 30px;
    }

    .post-image {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: var(--shadow-light);
        transition: transform 0.3s ease;
    }

    .post-image:hover {
        transform: scale(1.02);
    }

    .no-image {
        height: 300px;
        background: #6C63FF;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 4rem;
        box-shadow: var(--shadow-light);
    }

    /* Content Section */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .info-card {
        background: var(--light-secondary);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--light-border);
        transition: all 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-light);
        border-color: var(--primary-light);
    }

    .info-icon {
        width: 40px;
        height: 40px;
        background: #6C63FF;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        color: white;
        font-size: 1.1rem;
    }

    .info-label {
        font-size: 0.85rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .info-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        line-height: 1.4;
    }

    .info-value.price {
        color: var(--primary);
        font-size: 1.3rem;
    }

    /* Description Section */
    .description-section {
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title::before {
        content: '';
        width: 6px;
        height: 6px;
        background: #6C63FF;
        border-radius: 50%;
    }

    .description-content {
        background: var(--light-secondary);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--light-border);
        line-height: 1.7;
        color: var(--text-medium);
        font-size: 1.05rem;
    }

    /* Right Column - Map & Actions */
    .post-sidebar {
        padding: 40px;
        background: var(--light-secondary);
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    /* Map Section */
    .map-section {
        flex: 1;
    }

    .map-container {
        height: 300px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-light);
        border: 1px solid var(--light-border);
        background: var(--light-bg);
    }

    #post-map {
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }

    .map-controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .map-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--light-border);
        background: white;
        color: var(--text-dark);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    .map-btn:hover {
        background: var(--primary);
        color: white;
    }

    .map-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .route-info {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--light-border);
        font-size: 0.9rem;
    }

    .route-info.hidden {
        display: none;
    }

    /* Location Info */
    .location-info {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--light-border);
        box-shadow: var(--shadow-light);
    }

    .location-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .location-details {
        color: var(--text-medium);
        line-height: 1.5;
    }

    /* Contact & Actions */
    .contact-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid var(--light-border);
        box-shadow: var(--shadow-light);
    }

    .contact-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .contact-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .contact-btn {
        padding: 12px 20px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        text-align: center;
        justify-content: center;
    }

    .message-btn {
        background: #6C63FF;
        color: white;
        box-shadow: var(--shadow-light);
    }

    .message-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        background: #5A52D5;
    }

    .call-btn {
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--light-border);
    }

    .call-btn:hover {
        background: var(--primary-light);
        color: white;
        border-color: var(--primary);
    }

    /* Actions Section */
    .actions-section {
        padding: 30px 40px;
        border-top: 1px solid var(--light-border);
        background: var(--light-secondary);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 12px 24px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .back-btn {
        background: #6C63FF;
        color: white;
        box-shadow: var(--shadow-light);
    }

    .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        background: #5A52D5;
    }

    .edit-btn {
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--light-border);
    }

    .edit-btn:hover {
        background: var(--primary-light);
        color: white;
        border-color: var(--primary);
    }

    .delete-btn {
        background: var(--secondary);
        color: white;
        box-shadow: var(--shadow-light);
    }

    .delete-btn:hover {
        background: var(--secondary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        box-shadow: var(--shadow-large);
        text-align: center;
    }

    .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary {
        background: var(--text-light);
        color: white;
    }

    .btn-secondary:hover {
        background: var(--text-medium);
    }

    .btn-danger {
        background: var(--secondary);
        color: white;
    }

    .btn-danger:hover {
        background: var(--secondary-dark);
    }

    .delete-form {
        margin: 0;
        padding: 0;
        display: inline;
    }

    /* Animations */
    @keyframes fadeInUp {
        0% { opacity: 0; transform: translateY(30px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    .action-btn, .contact-btn {
        position: relative;
        overflow: hidden;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .post-main-content {
            grid-template-columns: 1fr;
        }
        
        .post-content-column {
            border-right: none;
            border-bottom: 1px solid var(--light-border);
        }
        
        .post-sidebar {
            padding: 30px;
        }
    }

    @media (max-width: 768px) {
        .post-detail-container {
            margin: 20px;
        }

        .post-header {
            padding: 30px 25px 20px;
        }

        .post-title {
            font-size: 1.8rem;
        }

        .post-content-column {
            padding: 30px 25px;
        }

        .info-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .post-sidebar {
            padding: 25px;
        }

        .actions-section {
            padding: 25px;
            flex-direction: column;
        }

        .action-btn {
            width: 100%;
            justify-content: center;
        }

        .modal-actions {
            flex-direction: column;
        }
    }

    @media (max-width: 480px) {
        .post-header {
            padding: 25px 20px 15px;
        }

        .post-title {
            font-size: 1.6rem;
        }

        .post-content-column {
            padding: 25px 20px;
        }

        .post-image-section {
            margin-bottom: 20px;
        }

        .info-card {
            padding: 15px;
        }

        .description-content {
            padding: 15px;
        }

        .post-sidebar {
            padding: 20px;
        }
    }
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9KO1U7_6JxlBuCpiLju_K0tXwBM4ISWE&libraries=geometry,places&language=hy"></script>
{% endblock %}

{% block body %}
<main class="page-main">
    <section class="post-detail-container">
        <!-- Header -->
        <div class="post-header">
            <h1 class="post-title">{{ post.title }}</h1>
            <div class="post-meta">
                <div class="post-status status-{% if post.assigned_to == request.user %}worker{% else %}{{ post.status }}{% endif %}">
                    {% if post.assigned_to == request.user %}
                        Աշխատող
                    {% else %}
                        {{ post.get_status_display }}
                    {% endif %}
                </div>
                <div class="post-date">
                    <i class="fas fa-calendar"></i>
                    {{ post.created_at|date:"F d, Y" }}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="post-main-content">
            <!-- Left Column - Content -->
            <div class="post-content-column">
                <!-- Image -->
                <div class="post-image-section">
                    {% if post.image %}
                        <img src="{{ post.image.url }}" alt="{{ post.title }}" class="post-image">
                    {% else %}
                        <div class="no-image">
                            <i class="fas fa-tasks"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Info Grid -->
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="info-label">Տեղակայություն</div>
                        <div class="info-value">{{ post.location|default:"Չի նշված" }}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="info-label">Գին</div>
                        <div class="info-value price">
                            {% if post.price %}
                                {{ post.price }} դրամ
                            {% else %}
                                Չի նշված
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-tag"></i>
                        </div>
                        <div class="info-label">Կատեգորիա</div>
                        <div class="info-value">{{ post.category.name|default:"Չի նշված" }}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="info-label">Շրջան</div>
                        <div class="info-value">
                            {% if post.province and post.state %}
                                {{ post.province.name }}, {{ post.state.name }}
                            {% else %}
                                Չի նշված
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="description-section">
                    <h3 class="section-title">
                        <i class="fas fa-align-left"></i>
                        Նկարագրություն
                    </h3>
                    <div class="description-content">
                        {{ post.description|default:"Այս հայտարարությունը նկարագրություն չունի։"|linebreaks }}
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="info-label">Դիտումներ</div>
                        <div class="info-value">{{ post.views_count }}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="info-label">Հաղորդագրություններ</div>
                        <div class="info-value">0</div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Map & Actions -->
            <div class="post-sidebar">
                <!-- Map Section -->
                <div class="map-section">
                    <h3 class="section-title">
                        <i class="fas fa-map"></i>
                        Տեղակայություն Քարտեզի Վրա
                    </h3>
                    <div class="map-container">
                        <div id="post-map"></div>
                    </div>
                    <div class="map-controls">
                        <button id="get-route-btn" class="map-btn" disabled>
                            <i class="fas fa-route"></i>
                            Ցույց տալ երթուղին
                        </button>
                        <button id="locate-me-btn" class="map-btn">
                            <i class="fas fa-location-arrow"></i>
                            Գտնել իմ տեղը
                        </button>
                        <button id="clear-route-btn" class="map-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                            Մաքրել երթուղին
                        </button>
                    </div>
                    <div id="route-info" class="route-info hidden">
                        <div id="route-distance"></div>
                        <div id="route-duration"></div>
                    </div>
                </div>

                <!-- Location Details -->
                <div class="location-info">
                    <h4 class="location-title">
                        <i class="fas fa-info-circle"></i>
                        Տեղակայության Մանրամասներ
                    </h4>
                    <div class="location-details">
                        <p><strong>Հասցե:</strong> {{ post.location|default:"Չի նշված" }}</p>
                        {% if post.province and post.state %}
                            <p><strong>Շրջան:</strong> {{ post.province.name }}, {{ post.state.name }}</p>
                        {% endif %}
                        <p><strong>Կատեգորիա:</strong> {{ post.category.name|default:"Չի նշված" }}</p>
                    </div>
                </div>

                <!-- Contact Section -->
                <div class="contact-section">
                    <h4 class="contact-title">
                        <i class="fas fa-user"></i>
                        Կապ Հաստատել
                    </h4>
                    <div class="contact-buttons">
                        <a href="{% url 'create_room' post.user.username %}" class="contact-btn message-btn">
                            <i class="fas fa-comment"></i>
                            Հաղորդագրություն Ուղարկել
                        </a>
                        <button class="contact-btn call-btn" onclick="showContactInfo()">
                            <i class="fas fa-phone"></i>
                            Կոնտակտային Տվյալներ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-section">
            <a href="{% url 'myposts' %}" class="action-btn back-btn">
                <i class="fas fa-arrow-left"></i>
                Վերադառնալ Իմ Հայտարարություններին
            </a>
            
            {% if post.user == request.user %}
            <!-- Кнопка редактирования -->
            <a href="{% url 'edit_post' post.id %}" class="action-btn edit-btn">
                <i class="fas fa-edit"></i>
                Խմբագրել Հայտարարությունը
            </a>
            
            <!-- Кнопка удаления с подтверждением -->
            <form method="post" action="{% url 'delete_post' post.id %}" class="delete-form">
                {% csrf_token %}
                <button type="button" class="action-btn delete-btn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i>
                    Ջնջել Հայտարարությունը
                </button>
            </form>
            {% endif %}
        </div>
    </section>
</main>

<!-- Модальное окно подтверждения удаления -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Հաստատել ջնջումը</h3>
        <p>Դուք վստահ եք, որ ցանկանում եք ջնջել «<strong>{{ post.title }}</strong>» հայտարարությունը:</p>
        <p style="color: var(--secondary); font-weight: 600; margin: 15px 0;">⚠️ Այս գործողությունը հնարավոր չէ հետարկել</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Չեղարկել</button>
            <button type="button" class="btn btn-danger" onclick="submitDelete()">Հաստատել ջնջումը</button>
        </div>
    </div>
</div>

<script>
    let map;
    let directionsService;
    let directionsRenderer;
    let userMarker;
    let destinationMarker;
    let userLocation = null;
    let destinationLocation = null;

    // Initialize Google Map
    function initMap() {
        // Default coordinates (Yerevan, Armenia)
        const defaultLocation = { lat: 40.1792, lng: 44.4991 };
        
        // Create map
        map = new google.maps.Map(document.getElementById('post-map'), {
            zoom: 12,
            center: defaultLocation,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            styles: [
                {
                    featureType: 'poi',
                    elementType: 'labels',
                    stylers: [{ visibility: 'on' }]
                }
            ]
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false,
            polylineOptions: {
                strokeColor: '#6C63FF',
                strokeOpacity: 0.8,
                strokeWeight: 6
            }
        });

        // Try to geocode the location if available
        const location = "{{ post.location }}";
        if (location && location !== "Չի նշված") {
            geocodeLocation(location);
        } else {
            // Show default marker
            createDestinationMarker(defaultLocation, '{{ post.title }}');
            destinationLocation = defaultLocation;
        }

        // Add event listeners for buttons
        document.getElementById('get-route-btn').addEventListener('click', calculateRoute);
        document.getElementById('locate-me-btn').addEventListener('click', locateUser);
        document.getElementById('clear-route-btn').addEventListener('click', clearRoute);

        // Add interactive animations
        addInteractiveAnimations();
    }
    
    // Geocode location using Google Geocoding API
    function geocodeLocation(location) {
        const geocoder = new google.maps.Geocoder();
        
        geocoder.geocode({ 
            address: location + ', Armenia',
            region: 'am'
        }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const location = results[0].geometry.location;
                destinationLocation = {
                    lat: location.lat(),
                    lng: location.lng()
                };
                
                // Update map view
                map.setCenter(destinationLocation);
                map.setZoom(14);
                
                // Create destination marker
                createDestinationMarker(destinationLocation, '{{ post.title }}');
                
            } else {
                console.error('Geocode was not successful for the following reason: ' + status);
                showDefaultMap();
            }
        });
    }
    
    function showDefaultMap() {
        const defaultLocation = { lat: 40.1792, lng: 44.4991 };
        map.setCenter(defaultLocation);
        map.setZoom(10);
        createDestinationMarker(defaultLocation, '{{ post.title }} - Տեղակայությունը չի գտնվել');
        destinationLocation = defaultLocation;
    }

    function createDestinationMarker(location, title) {
        if (destinationMarker) {
            destinationMarker.setMap(null);
        }
        
        destinationMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: title,
            icon: {
                url: 'data:image/svg+xml;base64,' + btoa(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="14" fill="#6C63FF" stroke="white" stroke-width="2"/>
                        <circle cx="16" cy="16" r="6" fill="white"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 16)
            }
        });

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div style="text-align: center; padding: 8px;">
                    <strong>${title}</strong><br>
                    <small>{{ post.location|default:"Տեղակայությունը չի նշված" }}</small>
                </div>
            `
        });

        destinationMarker.addListener('click', () => {
            infoWindow.open(map, destinationMarker);
        });
        
        infoWindow.open(map, destinationMarker);
    }

    function createUserMarker(location) {
        if (userMarker) {
            userMarker.setMap(null);
        }
        
        userMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: 'Ձեր տեղակայությունը',
            icon: {
                url: 'data:image/svg+xml;base64,' + btoa(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="14" fill="#FF6584" stroke="white" stroke-width="2"/>
                        <circle cx="16" cy="16" r="6" fill="white"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 16)
            }
        });

        const infoWindow = new google.maps.InfoWindow({
            content: '<strong>Ձեր տեղակայությունը</strong>'
        });

        userMarker.addListener('click', () => {
            infoWindow.open(map, userMarker);
        });
        
        infoWindow.open(map, userMarker);
    }

    // Locate user
    function locateUser() {
        if (!navigator.geolocation) {
            alert('Ձեր բրաուզերը չի աջակցում գեոլոկացիան');
            return;
        }

        const locateBtn = document.getElementById('locate-me-btn');
        locateBtn.disabled = true;
        locateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Որոնում...';

        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Create user marker
                createUserMarker(userLocation);
                
                // Center map on user location
                map.setCenter(userLocation);
                map.setZoom(14);
                
                locateBtn.disabled = false;
                locateBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Գտնել իմ տեղը';
                
                // Enable route calculation if destination is available
                if (destinationLocation) {
                    document.getElementById('get-route-btn').disabled = false;
                }
            },
            function(error) {
                let errorMessage = 'Չհաջողվեց գտնել ձեր տեղակայությունը: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Հասցեի թույլտվությունը մերժվել է:';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Տեղեկատվությունը հասանելի չէ:';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Հարցման ժամանակը սպառվել է:';
                        break;
                    default:
                        errorMessage += 'Անհայտ սխալ:';
                        break;
                }
                alert(errorMessage);
                locateBtn.disabled = false;
                locateBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Գտնել իմ տեղը';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    // Calculate route using Google Directions API
    function calculateRoute() {
        if (!userLocation) {
            alert('Խնդրում ենք նախ գտնել ձեր տեղակայությունը');
            return;
        }

        if (!destinationLocation) {
            alert('Հայտարարության տեղակայությունը չի գտնվել');
            return;
        }

        const routeBtn = document.getElementById('get-route-btn');
        routeBtn.disabled = true;
        routeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Հաշվարկում...';

        const request = {
            origin: userLocation,
            destination: destinationLocation,
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            language: 'hy'
        };

        directionsService.route(request, function(result, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                
                // Display route information
                const route = result.routes[0].legs[0];
                const distance = (route.distance.value / 1000).toFixed(1);
                const duration = Math.round(route.duration.value / 60);
                
                document.getElementById('route-distance').textContent = `Հեռավորություն: ${distance} կմ`;
                document.getElementById('route-duration').textContent = `Տևողություն: ${duration} րոպե`;
                document.getElementById('route-info').classList.remove('hidden');
                
                document.getElementById('clear-route-btn').style.display = 'block';
                
                routeBtn.disabled = false;
                routeBtn.innerHTML = '<i class="fas fa-route"></i> Ցույց տալ երթուղին';
            } else {
                alert('Չհաջողվեց հաշվարկել երթուղին: ' + status);
                routeBtn.disabled = false;
                routeBtn.innerHTML = '<i class="fas fa-route"></i> Ցույց տալ երթուղին';
            }
        });
    }

    // Clear route
    function clearRoute() {
        directionsRenderer.setDirections({ routes: [] });
        document.getElementById('route-info').classList.add('hidden');
        document.getElementById('clear-route-btn').style.display = 'none';
        
        if (userLocation && destinationLocation) {
            document.getElementById('get-route-btn').disabled = false;
        }
    }
    
    // Contact info modal
    function showContactInfo() {
        alert('Կոնտակտային տվյալներ:\n\nՕգտատեր: {{ post.user.username }}\nԷլ. փոստ: {{ post.user.email }}\n\nԽնդրում ենք օգտագործել հաղորդագրությունների համակարգը կապ հաստատելու համար։');
    }

    // Delete confirmation functions
    function confirmDelete() {
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    function submitDelete() {
        document.querySelector('.delete-form').submit();
    }

    // Add interactive animations
    function addInteractiveAnimations() {
        // Add hover effects to info cards
        const infoCards = document.querySelectorAll('.info-card');
        infoCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // Add click animation to action buttons
        const actionButtons = document.querySelectorAll('.action-btn, .contact-btn');
        actionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // Create ripple effect
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    pointer-events: none;
                `;
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });
    }
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize map when Google Maps API is loaded
        if (typeof google !== 'undefined') {
            initMap();
        } else {
            console.error('Google Maps API not loaded');
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Track post view
        trackPostView();
    });

    // Track post view
    function trackPostView() {
        const postId = {{ post.id }};
        
        fetch(`/task/${postId}/track-view/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('View tracked successfully');
            }
        })
        .catch(error => {
            console.error('Error tracking view:', error);
        });
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}