{% extends 'base.html' %}
{% load static %}
{% block body %}
<link rel="stylesheet" href="{% static 'css/create_post.css' %}">

<main class="container">

    <!-- HEADER -->
    <section class="header-section">
        <h1 class="main-title">Ստեղծել Նոր Հայտարարություն</h1>
        <p class="subtitle">Ավելացրու հայտարարություն արագ և հարմարավետ</p>
    </section>

    <!-- FORM -->
    <section class="form-section">
        <form method="POST" enctype="multipart/form-data" class="post-form" id="taskForm">
            {% csrf_token %}

            <!-- Title -->
            <div class="form-group">
                <label for="id_title">Վերնագիր</label>
                {{ form.title }}
            </div>

            <!-- IMAGE UPLOAD -->
            <div class="file-input-wrapper">
                <input type="file" name="image" id="image" class="file-input" accept="image/*"/>
                <label for="image" class="file-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-upload" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V4h-2v6H8l4 4z"/>
                    </svg>
                    Վերբեռնել Նկար
                </label>
                <span class="file-text" id="file-text">Նկար ընտրված չէ</span>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="id_description">Նկարագրություն</label>
                {{ form.description }}
            </div>

            <!-- Price -->
            <div class="form-group">
                <label for="id_price">Գին</label>
                {{ form.price }}
            </div>

            <!-- Category -->
            <div class="form-group">
                <label for="id_category">Ընտրել Կատեգորիան</label>
                {{ form.category }}
            </div>

            <!-- Marz -->
            <div class="form-group">
                <label for="state-select">Ընտրել Մարզը</label>
                {{ form.state }}
            </div>

            <!-- Shrjan -->
            <div class="form-group">
                <label for="province-select">Ընտրել Շրջան</label>
                {{ form.province }}
            </div>

            <!-- Address -->
            <div class="form-group">
                <label for="id_location">Հասցե</label>
                {{ form.location }}
            </div>

            <!-- Hidden fields for lat/lng -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <!-- Map preview -->
            <div id="map" style="width: 100%; height: 400px; margin-bottom: 15px;"></div>
            <div id="distanceInfo" style="margin-bottom: 20px; font-weight: bold;"></div>

            <!-- Submit -->
            <button type="submit" class="submit-btn">Հաստատել</button>
        </form>
    </section>

    <!-- INFO CARDS -->
    <section class="info-cards">
        <div class="card">
            <h3>Խորհուրդ 1</h3>
            <p>Կազմակերպիր քո հայտարարությունները ըստ առաջնահերթության։</p>
        </div>
        <div class="card">
            <h3>Խորհուրդ 2</h3>
            <p>Օգտագործիր պիտակներ՝ արագ գտնելու համար։</p>
        </div>
        <div class="card">
            <h3>Խորհուրդ 3</h3>
            <p>Վերանայիր լրացված հայտարարությունները՝ առաջընթացը տեսնելու համար։</p>
        </div>
    </section>

</main>

<!-- GOOGLE MAPS API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9KO1U7_6JxlBuCpiLju_K0tXwBM4ISWE=&libraries=places&language=hy"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const fileBtn = document.querySelector('.file-btn');
    const fileInput = document.getElementById('image');
    const fileText = document.getElementById('file-text');
    const form = document.getElementById('taskForm');
    const stateSelect = document.getElementById('state-select');
    const provinceSelect = document.getElementById('province-select');

    let resizedFileReady = false;

    // IMAGE RESIZE
    fileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        fileText.textContent = file.name;
        resizedFileReady = false;

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 250;
                canvas.height = 250;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    const newFile = new File([blob], file.name, { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(newFile);
                    fileInput.files = dataTransfer.files;
                    resizedFileReady = true;
                }, 'image/jpeg', 0.9);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    // CASCADING STATE -> PROVINCE
    stateSelect.addEventListener('change', async () => {
        provinceSelect.innerHTML = '<option value="">Ընտրել Շրջան</option>';
        if (!stateSelect.value) return;
        const resp = await fetch(`/get_provinces/${stateSelect.value}/`);
        const data = await resp.json();
        data.provinces.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.name;
            provinceSelect.appendChild(option);
        });
    });

    // FORM VALIDATION
    form.addEventListener('submit', e => {
        if (!resizedFileReady) {
            e.preventDefault();
            alert('Խնդրում ենք սպասել, նկարը մշակվում է...');
        }
        if (!stateSelect.value || !provinceSelect.value) {
            e.preventDefault();
            alert('Խնդրում ենք ընտրել մարզն ու շրջանը:');
        }
    });

    // GOOGLE MAP + AUTOCOMPLETE + USER LOCATION + ROUTE
    const addressInput = document.getElementById('id_location');
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    const distanceInfo = document.getElementById('distanceInfo');

    const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.1792, lng: 44.4991 }, // Yerevan
        zoom: 12
    });

    const destinationMarker = new google.maps.Marker({ map: map });
    let userMarker = null;
    let directionsService = new google.maps.DirectionsService();
    let directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

    // Autocomplete for address
    const autocomplete = new google.maps.places.Autocomplete(addressInput, {
        types: ['address'],
        componentRestrictions: { country: 'am' }
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        const destLat = place.geometry.location.lat();
        const destLng = place.geometry.location.lng();

        latInput.value = destLat;
        lngInput.value = destLng;

        destinationMarker.setPosition(place.geometry.location);
        map.setCenter(place.geometry.location);
        map.setZoom(16);

        if (userMarker) {
            calculateAndDisplayRoute(userMarker.getPosition(), place.geometry.location);
        }
    });

    // Try to get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            userMarker = new google.maps.Marker({
                position: userPos,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#ffffff'
                },
                title: 'Your Location'
            });
            map.setCenter(userPos);
        });
    }

    // Calculate route & distance
    function calculateAndDisplayRoute(origin, destination) {
        directionsService.route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING
        }, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
                const route = result.routes[0].legs[0];
                distanceInfo.textContent = `Distance: ${route.distance.text}, Duration: ${route.duration.text}`;
            } else {
                console.error('Directions request failed due to ' + status);
            }
        });
    }

});
</script>

{% endblock %}
