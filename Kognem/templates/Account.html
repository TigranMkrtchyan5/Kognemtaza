{% load static %}
<!DOCTYPE html>
<html lang="hy">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kognem ‚Äî ’ä÷Ä’∏÷Ü’´’¨</title>
<link rel="stylesheet" href="{% static 'css/Account.css' %}">
<style>
.edit-input{display:none;width:100%;padding:5px;margin-top:3px;border:1px solid #ccc;border-radius:4px;}
.error-msg{color:red;font-size:12px;margin-top:2px;display:none;}
.success-msg{color:green;font-size:12px;margin-top:2px;display:none;}
.controls button{margin-top:5px;margin-right:5px;}
.invalid{border-color:red;}
.controls button.save{background:linear-gradient(90deg,#2ecc71,#27ae60);color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;}
.controls button.cancel{background:#ff4d4d;color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;}
#logout-btn{display:block;width:100%;margin-top:20px;padding:10px;background:#ff4d4d;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;}
</style>
</head>
<body>

<header>
  <div class="header-container">
    <div class="brand">Kognem</div>
    <nav class="main-nav">
      <a href="{% url 'home' %}">‘≥’¨’≠’°’æ’∏÷Ä ’ß’ª</a>
      <a href="{% url 'ashxatanq' %}">‘±’º’°’ª’°’§÷Ä’°’∂÷Ñ’∂’•÷Ä</a>
    </nav>
    <div class="auth-buttons">
      {% if user.is_authenticated %}
        <a href="{% url 'Account' %}" class="btn-profile">{{ user.first_name }} {{ user.last_name }}</a>
      {% else %}
        <a href="{% url 'login' %}" class="btn-login">Login</a>
        <a href="{% url 'register' %}" class="btn-register">Register</a>
      {% endif %}
    </div>
  </div>
</header>

<main class="page-main">
  <section class="profile-container">
    <h1 class="profile-title">‘ª’¥ ’°’∂’±’∂’°’Ø’°’∂ ’ß’ª’®</h1>

    <form id="accountForm" method="POST" action="{% url 'Account' %}">
      {% csrf_token %}
      <div id="globalSuccess" class="success-msg">‚úî ’ä’°’∞’∫’°’∂’æ’°’Æ ’ß</div>

      <!-- Full Name -->
      <div class="profile-field" data-field="full_name">
        <label>‘±’∂’∏÷Ç’∂ ‘±’¶’£’°’∂’∏÷Ç’∂</label>
        <div class="values">
          <div class="current-value">{{ user.first_name }} {{ user.last_name }}</div>
          <input class="edit-input" name="full_name" type="text" value="{{ user.first_name }} {{ user.last_name }}">
          <div class="error-msg"></div>
        </div>
        <div class="controls"><button type="button" class="edit-btn">‚úèÔ∏è</button></div>
      </div>

      <!-- Username -->
      <div class="profile-field" data-field="username">
        <label>’ï’£’ø’°’£’∏÷Ä’Æ’°’∂’∏÷Ç’∂</label>
        <div class="values">
          <div class="current-value">{{ user.username }}</div>
          <input class="edit-input" name="username" type="text" value="{{ user.username }}">
          <div class="error-msg"></div>
          <div class="success-msg">‚úî ’ï’£’ø’°’£’∏÷Ä’Æ’°’∂’∏÷Ç’∂’® ’°’¶’°’ø ’ß</div>
        </div>
        <div class="controls"><button type="button" class="edit-btn">‚úèÔ∏è</button></div>
      </div>

      <!-- Email -->
      <div class="profile-field" data-field="email">
        <label>‘∑’¨. ’∞’°’Ω÷Å’•</label>
        <div class="values">
          <div class="current-value">{{ user.email }}</div>
          <input class="edit-input" name="email" type="email" value="{{ user.email }}">
          <div class="error-msg"></div>
        </div>
        <div class="controls"><button type="button" class="edit-btn">‚úèÔ∏è</button></div>
      </div>

      <!-- Phone -->
      <div class="profile-field" data-field="phone">
        <label>’Ä’•’º’°’≠’∏’Ω’°’∞’°’¥’°÷Ä</label>
        <div class="values">
          <div class="current-value">{{ profile.phone }}</div>
          <input class="edit-input" name="phone" type="text" value="{{ profile.phone }}" placeholder="0XXXXXXXX">
          <div class="error-msg"></div>
        </div>
        <div class="controls"><button type="button" class="edit-btn">‚úèÔ∏è</button></div>
      </div>

      <!-- Verification ID -->
      <div class="profile-field" data-field="verification_id">
        <label>’Ä’°’Ω’ø’°’ø’¥’°’∂ ID</label>
        <div class="values">
          <div class="current-value">{{ profile.verification_id }}</div>
          <input class="edit-input" name="verification_id" type="text" value="{{ profile.verification_id }}">
          <div class="error-msg"></div>
        </div>
        <div class="controls"><button type="button" class="edit-btn">‚úèÔ∏è</button></div>
      </div>
    </form>

    <!-- Logout form -->
    <form id="logout-form" action="{% url 'logout' %}" method="post" style="margin-top: 30px;">
      {% csrf_token %}
      <button id="logout-btn" type="submit">‘¥’∏÷Ç÷Ä’Ω ’£’°’¨</button>
    </form>
  </section>
</main>

<script>
const accountForm = document.getElementById('accountForm');
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let editingField = null;

function showError(fieldEl, msg){
  const err = fieldEl.querySelector('.error-msg');
  err.textContent = msg;
  err.style.display='block';
  fieldEl.querySelector('.edit-input').classList.add('invalid');
}
function hideError(fieldEl){
  const err = fieldEl.querySelector('.error-msg');
  err.style.display='none';
  fieldEl.querySelector('.edit-input').classList.remove('invalid');
}
function showSuccess(fieldEl){
  const msg = fieldEl.querySelector('.success-msg');
  msg.style.display='block';
  setTimeout(()=> msg.style.display='none', 2000);
}

// ---------------- Edit Mode ----------------
function enterEditMode(fieldEl){
  if(editingField) return;
  editingField = fieldEl;
  document.querySelectorAll('.edit-btn').forEach(b=>b.style.display='none');

  const span = fieldEl.querySelector('.current-value');
  const input = fieldEl.querySelector('.edit-input');
  span.style.display='none';
  input.style.display='block';
  input.focus();

  // hide error as soon as user types
  input.addEventListener('input', ()=> hideError(fieldEl));

  const controls = fieldEl.querySelector('.controls');

  const saveBtn = document.createElement('button');
  saveBtn.type='button';
  saveBtn.textContent='üíæ';
  saveBtn.classList.add('save');

  const cancelBtn = document.createElement('button');
  cancelBtn.type='button';
  cancelBtn.textContent='‚ùå';
  cancelBtn.classList.add('cancel');

  controls.appendChild(saveBtn);
  controls.appendChild(cancelBtn);

  cancelBtn.addEventListener('click', ()=>{
    input.value = span.textContent;
    span.style.display='block';
    input.style.display='none';
    saveBtn.remove();
    cancelBtn.remove();
    editingField = null;
    document.querySelectorAll('.edit-btn').forEach(b=>b.style.display='');
    hideError(fieldEl);
  });

  saveBtn.addEventListener('click', async ()=>{
    const value = input.value.trim();
    const field = fieldEl.dataset.field;

    // CLIENT-SIDE VALIDATION
    if(field === 'username'){
      if(value.length<3){
        showError(fieldEl,'’ï’£’ø’°’£’∏÷Ä’Æ’°’∂’∏÷Ç’∂’® ’∫’•’ø÷Ñ ’ß ’¨’´’∂’´ ‚â•3 ’∂’´’∑');
        return;
      }
      const resp = await fetch(`/check-username/?username=${value}`);
      const data = await resp.json();
      if(data.exists && value !== "{{ user.username }}"){
        showError(fieldEl,'’ï’£’ø’°’£’∏÷Ä’Æ’°’∂’∏÷Ç’∂’® ’°÷Ä’§’•’∂ ’¶’¢’°’≤’æ’°’Æ ’ß');
        return;
      } 
    }
    if(field==='full_name' && value.length<3){ showError(fieldEl,'‘±’∂’∏÷Ç’∂’® ’∫’°÷Ä’ø’°’§’´÷Ä ’ß'); return; }
    if(field==='email' && !value.includes('@')){ showError(fieldEl,'’ç’≠’°’¨ ’ß’¨. ’∞’°’Ω÷Å’•'); return; }
    if(field==='phone' && (!value.startsWith('0') || value.length!==9)){ showError(fieldEl,'’Ä’•’º’°’≠’∏’Ω’® ’∫’•’ø÷Ñ ’ß ’Ω’Ø’Ω’æ’´ 0-’∏’æ ÷á ’∏÷Ç’∂’•’∂’° 9 ’©’æ’°’∂’∑’°’∂'); return; }
    if(field==='verification_id' && !/^[A-Z0-9]+$/.test(value)){ showError(fieldEl,'’Ñ’•’Æ’°’ø’°’º ÷á ’∂’´’∑, ÷Ö÷Ä’´’∂’°’Ø ALO123'); return; }

    // Save via AJAX
    const formData = new FormData();
    formData.append('field', field);
    formData.append('value', value);
    formData.append('csrfmiddlewaretoken', csrfToken);

    const res = await fetch(accountForm.action,{
      method:'POST',
      body: formData,
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    });

    if(res.ok){
      fieldEl.querySelector('.current-value').textContent=value;
      span.style.display='block';
      input.style.display='none';
      saveBtn.remove();
      cancelBtn.remove();
      editingField = null;
      document.querySelectorAll('.edit-btn').forEach(b=>b.style.display='');
      showSuccess(fieldEl);
    }
  });
}

document.querySelectorAll('.edit-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const fieldEl = btn.closest('.profile-field');
    enterEditMode(fieldEl);
  });
});
</script>

</body>
</html>
