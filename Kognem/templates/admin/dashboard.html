{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body {font-family: 'Roboto', sans-serif; background: #1b1b1b; color: #eee; margin: 0; padding: 0;}
header {background: linear-gradient(90deg, #bfa54a, #6aa84f); padding: 20px; color: #fff; text-align: center; font-size: 32px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.5);}
main {padding: 30px;}
h2 {color: #bfa54a; margin-top: 40px; font-size: 24px; border-bottom: 2px solid #6aa84f; display: inline-block; padding-bottom: 5px;}
table {width: 100%; border-collapse: collapse; margin-top: 20px; background: #222; border-radius: 8px; overflow: hidden;}
th, td {padding: 12px; text-align: left; border-bottom: 1px solid #444;}
th {background-color: #6aa84f; color: #fff;}
tr:nth-child(even) {background-color: #1f1f1f;}
button {padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s;}
button:hover {opacity: 0.85;}
img {border-radius: 6px; max-width: 80px; max-height: 80px;}
.role {font-weight: bold; color: #ffd700;}
.action-buttons button {margin-right: 5px; margin-bottom: 3px;}

/* Specific Colors */
.ban {background-color: #b71c1c; color: #fff;}
.delete {background-color: #444; color: #fff;}
.reset {background-color: #bfa54a; color: #000;}
.banned-users-btn {background-color: #6a1b9a; color: #fff; padding: 10px 16px; font-size: 16px; border-radius: 8px; text-decoration: none; margin-left: 20px;}
</style>
</head>
<body>

<header>
    Admin Dashboard
    <a href="{% url 'banned_users' %}" class="banned-users-btn">Banned Users</a>
</header>

<main>

<!-- Users Section -->
<h2>Users</h2>
<table>
<tr>
    <th>ID</th>
    <th>Username</th>
    <th>Full Name</th>
    <th>Email</th>
    <th>Role</th>
    <th>Status</th>
    <th>Actions</th>
</tr>
{% for user in users %}
<tr>
    <td>{{ user.id }}</td>
    <td><a href="{% url 'user_detail' user.id %}" style="color:#bfa54a; text-decoration: underline;">{{ user.username }}</a></td>
    <td>{{ user.profile.full_name }}</td>
    <td>{{ user.email }}</td>
    <td class="role">{{ user.profile.role|capfirst }}</td>
    <td>
        {% if user.is_banned %}<span style="color:#b71c1c;">Banned</span>{% else %}<span style="color:#6aa84f;">Active</span>{% endif %}
    </td>
    <td class="action-buttons">
        {% if user.profile.role not in admin_roles %}
            {% if not user.is_banned %}
                <button class="ban" onclick="banUser('{{ user.id }}')">Ban</button>
            {% endif %}
            <button class="delete" onclick="deleteUser('{{ user.id }}')">Delete</button>
            <button class="reset" onclick="resetPassword('{{ user.id }}')">Reset Password</button>
        {% endif %}
    </td>
</tr>
{% endfor %}
</table>

<!-- Pending Posts Section -->
<h2>Pending Posts</h2>
<table>
<tr>
    <th>ID</th>
    <th>User</th>
    <th>Image</th>
    <th>Description</th>
    <th>Location</th>
    <th>Price</th>
    <th>Status</th>
    <th>Actions</th>
</tr>
{% for post in posts %}
<tr>
    <td>{{ post.id }}</td>
    <td>{{ post.user.username }}</td>
    <td>{% if post.image %}<img src="{{ post.image.url }}" alt="Image">{% endif %}</td>
    <td>{{ post.description }}</td>
    <td>{{ post.location }}</td>
    <td>{{ post.price }}</td>
    <td>{{ post.status|capfirst }}</td>
    <td class="action-buttons">
        {% if post.status == 'pending' %}
            <button class="approve" onclick="approvePost('{{ post.id }}')">Approve</button>
            <button class="reject" onclick="rejectPost('{{ post.id }}')">Reject</button>
        {% endif %}
    </td>
</tr>
{% endfor %}
</table>

</main>

<script>
async function banUser(userId){
    const reason = prompt("Enter ban reason:");
    if(!reason) return;
    const days = prompt("Enter ban duration in days (e.g., 7):");
    if(!days || isNaN(days)) return;
    const end_date = new Date();
    end_date.setDate(end_date.getDate() + parseInt(days));
    const res = await fetch(`/ban-user/${userId}/`, {
        method:'POST',
        headers: {'X-CSRFToken':'{{ csrf_token }}'},
        body: JSON.stringify({reason: reason, end_date: end_date.toISOString()})
    });
    if(res.ok) location.reload();
}

async function deleteUser(userId){
    if(!confirm("Are you sure you want to delete this user?")) return;
    const res = await fetch(`/delete-user/${userId}/`, {
        method:'POST',
        headers: {'X-CSRFToken':'{{ csrf_token }}'}
    });
    if(res.ok) location.reload();
}

async function resetPassword(userId){
    const newPassword = prompt("Enter new password for user:");
    if(!newPassword) return;
    const res = await fetch(`/reset-password/${userId}/`, {
        method:'POST',
        headers: {'X-CSRFToken':'{{ csrf_token }}'},
        body: JSON.stringify({password: newPassword})
    });
    if(res.ok) location.reload();
}

async function approvePost(postId){
    const res = await fetch(`/admin/posts/approve/${postId}/`, {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}});
    if(res.ok) location.reload();
}

async function rejectPost(postId){
    const res = await fetch(`/admin/posts/reject/${postId}/`, {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}});
    if(res.ok) location.reload();
}
</script>

</body>
</html>
