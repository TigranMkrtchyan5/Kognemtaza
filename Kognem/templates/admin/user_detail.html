{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>User Detail - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body {font-family: 'Roboto', sans-serif; background: #1b1b1b; color: #eee; margin: 0; padding: 0;}
header {background: linear-gradient(90deg, #bfa54a, #6aa84f); padding: 20px; color: #fff; text-align: center; font-size: 32px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.5);}
main {padding: 30px;}
h2 {color: #bfa54a; margin-top: 40px; font-size: 24px; border-bottom: 2px solid #6aa84f; display: inline-block; padding-bottom: 5px;}
table {width: 100%; border-collapse: collapse; margin-top: 20px; background: #222; border-radius: 8px; overflow: hidden;}
table th, table td {padding: 12px; text-align: left; border-bottom: 1px solid #444;}
table th {background-color: #6aa84f; color: #fff; font-weight: bold;}
table tr:nth-child(even) {background-color: #1f1f1f;}
button {padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s;}
button:hover {opacity: 0.85;}
img {border-radius: 6px; max-width: 80px; max-height: 80px;}
.role {font-weight: bold; color: #ffd700;}
.action-buttons button {margin-right: 5px; margin-bottom: 3px;}
.ban {background-color: #b71c1c; color: #fff;}
.unban {background-color: #1b5e20; color: #fff;}
.delete {background-color: #444; color: #fff;}
.reset {background-color: #bfa54a; color: #000;}
.approve {background-color: #ffb300; color: #000;}
.reject {background-color: #6a1b9a; color: #fff;}
</style>
</head>
<body>

<header>User Detail: {{ target_user.username }}</header>

<main>
<h2>User Info</h2>
<table>
<tr><th>Username</th><td>{{ target_user.username }}</td></tr>
<tr><th>Full Name</th><td>{{ target_user.profile.full_name }}</td></tr>
<tr><th>Email</th><td>{{ target_user.email }}</td></tr>
<tr><th>Phone</th><td>{{ target_user.profile.phone }}</td></tr>
<tr><th>Verification ID</th><td>{{ target_user.profile.verification_id }}</td></tr>
<tr><th>Role</th><td class="role">{{ target_user.profile.role|capfirst }}</td></tr>
<tr><th>Status</th>
    <td>
        {% if target_user.profile.is_banned %}
            <span style="color:#b71c1c;">Banned</span>
        {% else %}
            <span style="color:#6aa84f;">Active</span>
        {% endif %}
    </td>
</tr>
<tr>
    <th>Actions</th>
    <td class="action-buttons">
        {% if current_user.profile.role == 'superadmin' or current_user.profile.role == 'admin' %}
            {% if not target_user.profile.is_banned %}
                <button class="ban" onclick="banUser('{{ target_user.id }}')">Ban</button>
            {% else %}
                <button class="unban" onclick="unbanUser('{{ target_user.id }}')">Unban</button>
            {% endif %}
            <button class="delete" onclick="deleteUser('{{ target_user.id }}')">Delete</button>
            <button class="reset" onclick="resetPassword('{{ target_user.id }}')">Reset Password</button>
        {% endif %}
    </td>
</tr>
</table>

<h2>Ban Logs</h2>
<table>
<tr>
    <th>Admin</th>
    <th>Reason</th>
    <th>Start Date</th>
    <th>End Date</th>
    <th>Active</th>
</tr>
{% for ban in target_user.bans.all %}
<tr>
    <td>{% if ban.admin %}{{ ban.admin.username }}{% else %}System{% endif %}</td>
    <td>{{ ban.reason }}</td>
    <td>{{ ban.start_date|date:"Y-m-d H:i" }}</td>
    <td>{{ ban.end_date|date:"Y-m-d H:i" }}</td>
    <td>{% if ban.active %}<span style="color:#6aa84f;">Yes</span>{% else %}<span style="color:#b71c1c;">No</span>{% endif %}</td>
</tr>
{% empty %}
<tr><td colspan="5" style="text-align:center;">No bans found</td></tr>
{% endfor %}
</table>

<h2>User Posts</h2>
<table>
<tr>
    <th>ID</th>
    <th>Image</th>
    <th>Description</th>
    <th>Location</th>
    <th>Price</th>
    <th>Status</th>
</tr>
{% for post in target_user.posts.all %}
<tr>
    <td>{{ post.id }}</td>
    <td>{% if post.image %}<img src="{{ post.image.url }}" alt="Post Image">{% endif %}</td>
    <td>{{ post.description }}</td>
    <td>{{ post.location }}</td>
    <td>{{ post.price }}</td>
    <td>{{ post.status|capfirst }}</td>
</tr>
{% empty %}
<tr><td colspan="6" style="text-align:center;">No posts found</td></tr>
{% endfor %}
</table>

</main>

<script>
async function banUser(userId){
    const reason = prompt("Enter ban reason:");
    if(!reason) return;
    const days = prompt("Enter ban duration in days:");
    if(!days || isNaN(days)) return;
    const end_date = new Date();
    end_date.setDate(end_date.getDate() + parseInt(days));
    const res = await fetch(`/ban-user/${userId}/`, {
        method:'POST',
        headers: {'X-CSRFToken':'{{ csrf_token }}'},
        body: JSON.stringify({reason: reason, end_date: end_date.toISOString()})
    });
    if(res.ok) location.reload();
}

async function unbanUser(userId){
    const res = await fetch(`/unban-user/${userId}/`, {
        method:'POST',
        headers: {'X-CSRFToken':'{{ csrf_token }}'}
    });
    if(res.ok) location.reload();
}

async function deleteUser(userId){
    if(!confirm("Are you sure you want to delete this user?")) return;
    const res = await fetch(`/delete-user/${userId}/`, {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}});
    if(res.ok) location.reload();
}

async function resetPassword(userId){
    const res = await fetch(`/reset-password/${userId}/`, {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}});
    const data = await res.json();
    if(res.ok && data.success) alert("New password: " + data.new_password);
}
</script>

</body>
</html>
