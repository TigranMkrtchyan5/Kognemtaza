{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Banned Users</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body {font-family:'Roboto',sans-serif;background:#1b1b1b;color:#eee;margin:0;padding:0;}
header {background:linear-gradient(90deg,#bfa54a,#6aa84f);padding:20px;color:#fff;text-align:center;font-size:28px;font-weight:bold;}
main {padding:30px;}
h2 {color:#bfa54a;margin-top:30px;font-size:24px;border-bottom:2px solid #6aa84f;display:inline-block;}
table {width:100%;border-collapse:collapse;margin-top:20px;background:#222;border-radius:8px;overflow:hidden;}
th, td {padding:12px;text-align:left;border-bottom:1px solid #444;}
th {background-color:#6aa84f;color:#fff;}
tr:nth-child(even){background:#1f1f1f;}
button {padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;transition:0.3s;margin-right:5px;margin-bottom:3px;}
button:hover {opacity:0.85;}
.unban {background:#1b5e20;color:#fff;}
.back {background:#bfa54a;color:#000; float:right;}
</style>
</head>
<body>

<header>Banned Users</header>

<main>
<h2>All Banned Users</h2>
<a href="{% url 'admin_dashboard' %}"><button class="back">Back to Dashboard</button></a>

{% if banned_users %}
<table>
<tr>
<th>ID</th>
<th>Username</th>
<th>Full Name</th>
<th>Email</th>
<th>Role</th>
<th>Ban Reason</th>
<th>Banned Until</th>
<th>Actions</th>
</tr>
{% for user in banned_users %}
<tr>
<td>{{ user.id }}</td>
<td>{{ user.username }}</td>
<td>{{ user.profile.full_name }}</td>
<td>{{ user.email }}</td>
<td>{{ user.profile.role|capfirst }}</td>
<td>{{ user.active_ban.reason }}</td>
<td>{{ user.active_ban.end_date }}</td>
<td><button class="unban" onclick="unbanUser('{{ user.id }}')">Unban</button></td>
</tr>
{% endfor %}
</table>
{% else %}
<p style="color:#bfa54a;">No banned users at the moment.</p>
{% endif %}
</main>

<script>
async function unbanUser(userId){
    if(!confirm("Are you sure you want to unban this user?")) {
        return; // Отмена, если пользователь передумал
    }
    
    try {
        const res = await fetch(`/unban-user/${userId}/`, {
            method:'POST',
            headers:{'X-CSRFToken':'{{ csrf_token }}'}
        });
        
        if(res.ok) {
            // Если Django вернул статус 200, перезагружаем страницу
            alert('User successfully unbanned!');
            location.reload(); 
        } else {
            // Если Django вернул ошибку (403, 404, 500)
            let errorText = await res.text();
            
            // Пытаемся получить JSON-ответ, если он есть
            try {
                const errorJson = JSON.parse(errorText);
                errorText = errorJson.error || errorJson.message || res.statusText;
            } catch(e) {
                // Если это не JSON, используем текст или статус
                errorText = errorText || res.statusText;
            }
            
            alert(`Error during unban process (Status ${res.status}): ${errorText}`);
        }
    } catch(error) {
        // Ошибка сети или другая критическая ошибка
        alert("A network error occurred. Check your server connection.");
        console.error("Fetch error:", error);
    }
}
</script>

</body>
</html>